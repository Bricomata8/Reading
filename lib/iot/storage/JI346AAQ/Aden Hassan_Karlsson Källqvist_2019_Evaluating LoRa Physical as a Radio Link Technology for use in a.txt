Evaluating LoRa Physical as a Radio Link Technology for use in a Remote-Controlled Electric Switch System for a Network Bridge Radio-Node
Abdullahi Aden Hassan / Rasmus Karlsson Källqvist
KTH ROYAL INSTITUTE OF TECHNOLOGY
ELECTRICAL ENGINEERING AND COMPUTER SCIENCE

Acknowledgments
We would like to thank our academic mentor Anders Västberg for helping us with the process of writing and carrying through this degree project, answering all of our questions, and for proof reading this report. We would like to thank Amin Azari for showing genuine interest in our project and for answering some math questions we had when calculating the radio link budget, and for discovering that the formula in a book we were using had a printing error which was initially causing our results to be wrong. Thank you to fellow students Michael Henriksson and Sebastian Kullengren for a thorough opposition to this report and for much helpful feedback in keeping the text readable and scientific. Thank you to Björn Pehrson for representing AMPRNet Sweden and giving us the opportunity to work on this project, financing the system prototype and for giving helpful feedback. Finally, we would like to thank program director Bengt Molin for teaching us much of what we know of embedded systems and for lending us equipment used in the development of the hardware prototype.
i

Abstract
This report explores the design of a system for remotely switching electronics on and off within a range of at least 15 km, to be used with battery driven radio nodes for outdoor Wi-Fi network bridging. The application of the network bridges are connecting to remote networks, should Internet infrastructure fail during an emergency. The problem statement for the report was “What is a suitable radio link technology for use in a remote controlled electrical switch system and how should it best be put to use?” To answer the question, delimitation was done to exploring Low Power Wide Area Network (LPWAN) link technologies, due to their prior use within power constrained devices. Long Range-radio, abbreviated LoRa, is a LPWAN radio modulation technique and was determined to be a good candidate as a suitable link technology for the remote electrical switch system. The range of LoRa is achieved by drastically lowering the data rate of the transmission, and is suitable for battery-powered or energy harvesting devices such as those found in the field of Internet of Things. A LoRa-based transmitter and receiver pair was implemented, and measured to have a packet delivery ratio of over 95% at a distance of 2 km, measured between two bridges. Data at further distances could not be accurately determined, because of the LoRa transceiver giving faulty readings. No conclusion could be made about the suitability for using a LoRa based system to solve the problem, partially due to an improper method for testing the radio performance was used, and partially due to an inconclusive measurement result. Keywords LoRa; Emergency preparedness; Amateur radio; System design; Embedded system; Radio electronics
ii

Abstract
Denna rapport utforskar designen av ett system för att fjärrstyrt slå på eller av elektronik över ett avstånd på minst 15 km, för att användas med batteridrivna radionoder för nätverksbryggning utomhus med Wi-Fi. Tillämpningsområdet för nätverksbryggorna är att koppla samman avlägsna nätverk, om Internetinfrastruktur skulle sluta fungera vid en nödsituation. Problemställningen för rapporten var ”Vad är en lämplig radiolänksteknik att använda i ett fjärrstyrt elektriskt strömbrytarsystem, och hur ska det bäst brukas?”. För att svara på frågan gjordes en avgränsning att utforska Low Power Wide Area Network (LPWAN)-länktekniker, på grund av deras tidigare användning inom effektbegränsade enheter. Long Range-radio, förkortat LoRa, är en radiomodulationsteknik som används för att skicka data över långa avstånd med energibegränsade enheter. LoRa:s räckvidd uppnås genom att drastiskt sänka datatakten, och lämpar sig för bruk i batteridrivna eller energiskördande enheter, likt de som återfinns inom fältet Internet of Things. Ett LoRa-baserat sändar- och mottagarpar implementerades, och uppmättes till att ha en paketlevereringsmängd på över 95% vid ett avstånd på 2 km, mätt mellan två broar. Data vid större avstånd kunde inte bli bestämt noggrant, eftersom LoRa transceivern gav felaktiga avläsningar. Ingen slutsats kunde göras för lämpligheten för att använda ett LoRa-baserat system för att lösa problemet, delvist för att en olämplig metod för att testa radions prestanda använts, och delvist på grund av ett ofullständigt mätresultat. Nyckelord LoRa; Krisberedskap; Amatörradio; Systemdesign; Inbyggda system; Radioelektronik
iii

Definitions

AMPRnet Amateur Packet Radio network

BW

Bandwidth

CPU

Central processing unit

CR

Code rate

CSS

Chirp Spread Spectrum

ECC

Electronic Communications Committee

ERP

Effective radiated power

FEC

Forward Error Correction

FRO

The Voluntary Radio Organization

GPIO

General Purpose Input Output

ID

Identification

IoT

Internet of Things

ISM

Industrial, Scientific and Medical radio bands

LCD

Liquid Crystal Display

LoRa

Long Range

LoRaWAN LoRa Wide Area Network

LoS

Line of Sight

LPWAN Low-Power Wide-Area Network

MCU

Microcontroller Unit

MSB

Swedish Civil Contingencies Agency

NF

Noise Figure

PCB

Printed Circuit Board

PDR

Package Delivery Ratio

PL

Payload

PTS

Post and Telecommunication Agency

RC

Remote Controlled

RSSI

Received Signal Strength Indication

SF

Spread Factor

SK0MT Call sign for the radio amateur club Täby Sändaramatörer

SNR

Signal-to-Noise Ratio

SPI

Serial Peripheral Interface

UART

Universal Asynchronous Receiver-Transmitter

iv

TABLE OF CONTENTS
1 Introduction.................................................................................................................1 1.1 Background ..................................................................................................................... 1 1.2 Problem............................................................................................................................. 1 1.3 Goal ..................................................................................................................................... 2 1.4 Purpose ............................................................................................................................. 3 1.5 Methodology.................................................................................................................... 3 1.6 Delimitations .................................................................................................................. 3 1.7 Disposition....................................................................................................................... 4
2 Background..................................................................................................................5 2.1 Emergency management of telecom in Sweden ................................................. 5 2.2 Amateur radio resources in emergency management .................................... 5 2.3 Internet access via radio amateurs......................................................................... 6 2.4 Outdoor network bridging using battery driven radios ................................. 6 2.5 The network bridge attempted by AMPRNet Sweden...................................... 7 2.6 Technical description of the battery-driven radio node................................. 8
3 Method ...........................................................................................................................9 3.1 The design-science research methodology.......................................................... 9 3.2 Applying the methodology to this study .............................................................10 3.3 Literature study ...........................................................................................................11 3.4 Prototype system design ..........................................................................................11 3.5 Implementation of hardware..................................................................................11 3.6 Implementation of software....................................................................................12 3.7 Test of prototype system ..........................................................................................12
4 Literature Study ...................................................................................................... 13 4.1 Ingenu Ramp .................................................................................................................13 4.2 LoRa (Long Range) ......................................................................................................14 4.3 SigFox...............................................................................................................................15 4.4 Telensa ............................................................................................................................16 4.5 Suitability for the technologies in the prototype.............................................16 4.6 Related LoRa studies..................................................................................................17 4.6.1 LoRa Mobile-To-Base-Station Channel Characterization in the Antarctic....17 4.6.2 Range Evaluation and Channel Attenuation Model for LoRa Technology ....18 4.6.3 Performance Evaluation of LoRa Considering Scenario Conditions ...............18 4.6.4 Summary of related studies .............................................................................................19
5 Radio Link Theory .................................................................................................. 20 5.1 Transmission theory..................................................................................................20 5.1.1 Link budget and fading ......................................................................................................20 5.1.2 Free space propagation loss ............................................................................................20 5.1.3 Okumura-Hata model for propagation loss...............................................................21 5.1.4 Fresnel zones .........................................................................................................................22 5.2 ISM-band regulations.................................................................................................23 5.3 LoRa parameter configuration ...............................................................................23 5.3.1 Spread factor ..........................................................................................................................24 5.3.2 Bandwidth ...............................................................................................................................24 5.3.3 Code rate ..................................................................................................................................24 5.3.4 Data rate and transmission air time .............................................................................25
v

5.3.5 LoRa sensitivity.....................................................................................................................26 5.3.6 Selection of LoRa parameter values for RC electric switch system.................28 5.4 Theoretical communication range........................................................................28 5.4.1 Link between SK0MT and Ullna landfill......................................................................28 5.4.2 Link between Ullna landfill and Rindö Redoubt......................................................29
6 Implementation of Prototype ............................................................................. 30 6.1 Goal of implemented prototype .............................................................................30 6.2 Hardware components and assembly..................................................................30 6.2.1 STM32L1-Discovery development board ..................................................................30 6.2.2 RFM96 LoRa radio chip .....................................................................................................31 6.2.3 Flexi SMA90 Quarter-whip antenna ............................................................................31 6.2.4 Assembly..................................................................................................................................32 6.3 Transmitter and receiver software ......................................................................33 6.3.1 LoRa driver .............................................................................................................................34 6.3.2 Transmitter unit’s microcontroller firmware ..........................................................34 6.3.3 Receiver units’ microcontroller firmware .................................................................35 6.4 Validating functions for determining RSSI and SNR .......................................36 6.4.1 Code snippets .........................................................................................................................36 6.4.2 Validation of statistical functions ..................................................................................37
7 Simulations and Field Tests ................................................................................ 39 7.1 Simulating performance of radio links using Radio Mobile ........................39 7.1.1 Simulation settings and sites ...........................................................................................39 7.2 Measuring radio LoS-performance using local bridges.................................40 7.2.1 Considered measurement sites ......................................................................................40 7.2.2 Used measurement sites ...................................................................................................41 7.3 Characterizing the RFM96 RSSI meter.................................................................41
8 Result........................................................................................................................... 43 8.1 Simulation results .......................................................................................................43 8.2 Bridge measurements................................................................................................45 8.3 Ground measurements..............................................................................................48 8.4 RSSI characteristics ....................................................................................................49 8.4.1 Data read from RSSI chip ..................................................................................................49 8.4.2 RSSI characteristic curve with antenna equipped receiver ................................51
9 Discussion.................................................................................................................. 52 9.1 Interpreting results ....................................................................................................52 9.1.1 Radio Mobile simulation of radio links ........................................................................52 9.1.2 Packet delivery ratios when measuring between bridges ..................................52 9.1.3 Incorrect RSSI and SNR......................................................................................................53 9.1.4 Microcontroller RSSI readings and processing........................................................53 9.2 Other suitable measurement methods................................................................54 9.3 Evaluation of chosen research methodology ....................................................54 9.4 Future work...................................................................................................................55 9.5 Conclusion......................................................................................................................55
References.......................................................................................................................... 57
vi

1 Introduction
This report documents a design process for a remote-controlled electric switch system that was commissioned by the association AMPRnet Sweden. The association had used battery-driven radio equipment that discharged its batteries to quickly in stand-by mode, and wanted to be able to turn the electronics on and off as needed.
The introductory chapter will present the background leading up to the commissioning of the electric switch system, present the problem this report investigates and describe how a prototype system was to be developed.
1.1 Background
The association AMPRnet Sweden is working with the construction of a backup Internet infrastructure in Sweden using radio amateur resources, as an aid to Swedish emergency preparedness agencies.
Those resources take the form of the radio amateurs themselves, who have competence in using and managing communication technologies, and the equipment that they have available. One of the technologies that AMPRnet Sweden is interested in is outdoor Wi-Fi network-bridges, which can be used to physically connect two remote networks in the case that local IT infrastructure fails.
The network-bridges are formed with directional microwave-radios, and can cover great distances given a line-of-sight between transmitter and receiver. If two sites that need a connection does not have a direct line-of-sight, then radio nodes can be placed at intermediate sites where line-of-sight exists.
To ease the deployment of these intermediate radio nodes, they can be made portable by equipping them with batteries and solar cells. An experiment of such a setup was carried out by AMPRnet Sweden, attempting to connect the radio amateur club Täby Sändaramatörer and nearby Vaxholm Fortress with two intermediate battery powered nodes.
The experiment failed, when it was discovered that the radio equipment drained the batteries too quickly in standby mode, and a need was identified to be able to remotely turn the equipment on and off.
1.2 Problem
At its core, the problem this report investigates is making sure that power isn’t needlessly drawn from the radio nodes’ batteries. To accomplish this, a suitable system for switching electronics on and off remotely should be developed.
1

Such a system would have several aspects that would have to be investigated in order for it to function, topics such as:
• User interface that the operator can use to request deployed nodes to switch its electronics on or off.
• Protocol that dictates the format of those requests. • Suitable radio link technology to broadcast the requests from the
operator to the nodes. • Access from the base node of the operator to all other deployed nodes
through some network topology. • Security mechanism that authenticates a request from the operator to a
node, and protects the system from third-party attacks. • Low power consumption, so that the electrical switch system doesn’t
drain the batteries in any significant way.
All of these aspects are dependent on each other, and a good system design must take all of them into consideration. When making choices for one part of the system, such as the security mechanism or the radio link, one has to also think about how that choice influences the rest of the system and their ability to achieve the goal of reducing power consumption in the radio node.
The problem of making the design therefor becomes finding the best possible decisions for all the parts of the system with regards to their relation to each other and how they contribute to the overall system function.
To solve the design problem, the design can be broken down into several parts and focused on individually. The result of a study of one part could then inform the design decisions for the rest of the system.
This report therefore explores the question “What is a suitable radio link technology for use in a remote controlled electrical switch system and how should it best be put to use?”
1.3 Goal
The goal of this study is to find a simple proof of concept of the remote controlled electrical switch systems link-technology, by creating a design, implementing it, and then testing its performance.
This proof-of-concept should then serve as a foundation for a more elaborate and complete design, that could be used in the actual AMPRNet Sweden radio nodes.
In the problem scenario of the Täby–Vaxholm network bridge attempted by AMPRNet, the furthest distance between radio nodes was 15 km. Therefore, the proof-of-concept should let an operator communicate with nodes separated at up to at least 15 km.
2

1.4 Purpose
This report is written in order to document the findings of a suitable low power radio link technology’s performance in a real-life scenario, and to contribute to the capabilities of AMPRnet Sweden to provide in emergency management of ITinfrastructure, yielding a social benefit.
The application of the switch system is in the AMPRNet nodes, but could easily be generalized to any distributed system of hardware which power state needs to be controlled remotely. There is therefore a possible environmental benefit from the system explored in this report.
1.5 Methodology
The methodology employed in this project is Design-Science Research, as described by Hevner et al, where “knowledge and understanding of a problem domain and its solution are achieved in the building and application [a] designed artefact” [1].
Design-science when applied to developing a prototype system as described in the earlier sections becomes thoroughly designing, implementing and testing a system to better understand the constraints of the problem scenario, and the possibilities in solving it using the proposed prototype system.
1.6 Delimitations
Due to the time constrained nature of the project, some delimitations were imposed.
The focus is on implementing a system that could communicate between two neighbouring nodes. No attention is given to exploring security mechanisms, and only limited attention to power saving features. Additionally, the prototype is not given any capability to interface with any radio node electronics, focusing completely on the radio link.
For the communication between the network operator and the radio nodes, the focus was on multi-hopping between radio nodes in series rather than one powerful sender at the operator broadcasting to all nodes. This simplified implementation, since there was no easy access to powerful broadcasting equipment during conduction of this research.
The mathematical model for the problem scenario was kept simple, in-depth enough to make an informed decision when choosing radio system parameters, but not accounting for every detail.
Finally, the evaluation of the system was done so that it could give an indication of the radio channel’s performance, but not to thoroughly characterize it.
3

1.7 Disposition
The rest of this report is followed first by Chapter 2, which describes the association AMPRNet’s role in Swedish emergency preparedness and their network bridge experiment between Täby and Vaxholm in more detail. Chapter 3, Method, describes how the LoRa-based design was to be developed and tested and how LoRa came to be the chosen radio link technology for the project. Chapter 4 describes the mathematical process of deriving the choice of parameter values such as transmission power for the LoRa radio link to maximize the range of transmission. Chapter 5 describes the implementation of the proof-of-concept prototypes hardware and software. The validation of the prototype is described in Chapter 6, using simulations and a field test carried out between various bridges in Stockholm. Chapter 7 describes the result of those simulations and test measurements. Finally, chapter 8 will discuss the result of the simulation and field tests and try to determine whether the LoRa-based design successfully laid the groundwork for a more complete implementation of the remote controlled electrical switch system, or if another link technology should be used. Chapter 9 concludes the report with what has been learned, and the potential for future work within the problem area.
4

2 Background
This background chapter will present how Swedish state authorities work with emergency management of electronic communication and how radio amateurs are contributing to the agencies work.
The association AMPRnet Sweden will be introduced, that work with using radio amateur resources to secure Internet infrastructure, along with describing the attempt they made of establishing an outdoor network bridge between the radio club Täby Sändaramatörer and Vaxholm Fortress, using portable battery-driven radio nodes. Finally, the capabilities and principles of the radio technology LoRa will be described.
2.1 Emergency management of telecom in Sweden
Sweden is a connected country, increasingly relying on digital technology and electronic communication in industry, private life and public sector. In crisis preparedness, it is therefore of importance to make sure that infrastructure that supports electronic communication can withstand stress during an emergency.
The Swedish Civil Contingencies Agency (MSB) is a government agency that is organized under the Ministry of Defence, that works with managing and containing emergencies in Sweden by supervising, supporting and educating other authorities, actors in private sector and members of civil society [5].
On behalf of MSB, the Post and Telecommunication Agency (PTS) therefore performs regular exercises with Swedish telecommunications operators to increase their knowledge and experience with crisis preparedness.
In a report produced by the PTS about their crisis response strategy for 20072021, they state that companies and parts of civil society that can support crisis preparedness should do so. The electronic communication sector was identified as of particular interest for this kind of preparedness [6, p. 18].
2.2 Amateur radio resources in emergency management
Amateur radio is a hobby where radio enthusiasts broadcast and listen to radio for non-commercial use. Practitioners are called radio amateurs, and usually practice in amateur radio clubs.
These radio clubs form a part of civil society that can collaborate with crisis management agencies, and provide support in an ongoing crisis, by offering expertise and equipment for electronic communication.
The Voluntary Radio Organization (FRO) is a defence organization for citizens who want to contribute to emergency preparedness for electronic
5

communications and is an example of amateur radio resources being used for that purpose [7].
Radio clubs regularly participate in exercises and education organized by the FRO and have historically contributed to communication during crises. Radio amateurs therefor demonstrably form a natural part of civilian emergency preparedness.
2.3 Internet access via radio amateurs
The Internet is an important form of electronic communication, and therefore a priority to secure in case of an emergency. Internet connectivity is usually provided by a telecommunications operator but can also be provided using radio amateur resources.
AMPRnet (Amateur Packet Radio Network) is a collection of computer networks maintained by radio amateurs, based on IPv4 and IPv6 addresses reserved for radio amateur use in the American 1980s. These networks can be used for educational purposes, or act as an access-network to the Internet in crisis situations where commercial alternatives are unavailable [8].
AMPRnet Sweden is an association that administers the construction of a Swedish extension of the existing American AMPRnet, with the purpose of, among other things, making radio amateur resources more accessible to Swedish emergency preparedness organizations.
Participating radio clubs are encouraged, in a pamphlet written by the association, to use any of their available link technologies to connect resources such as repeaters, radio stations and sensor networks to the Swedish AMPRnet [9].
2.4 Outdoor network bridging using battery driven radios
An AMPERnet base and a network on a remote location can be connected using a network bridge, which links the networks together. An example of such a link is 5 GHz WiFi over microwave radio, which transmits data in concentrated line-ofsight broadcasts that can reach several tens of kilometres.
AMPRnet Sweden attempted in collaboration with the radio club Täby Sändaramatörer (call sign SK0MT), as a part of an emergency preparedness event on Vaxholm Fortress in the nearby archipelago, to establish a network bridge between SK0MT and the fortress using these kinds of microwave radios.
Figure 1, illustration of outdoor network bridging
6

SK0MT and Vaxholm Fortress do not have a direct line-of-sight, so two intermediary batteries driven radio nodes were used for the network bridge. One was placed on the top of the Ullna landfill nearby SK0MT, and the other on Rindö Redoubt (a 19th century military structure) adjacent to Vaxholm Fortress. Unfortunately, the experiment failed, because the radio equipment discharged the batteries while unused in standby mode. A need to remotely switch the equipment on or off when needed was identified. Such a remote-controlled on/off-switch, or electric switch system, would need to use a secondary radio that would be powered continuously and that has a range similar to that of the microwave radios. To not significantly drain the batteries, this secondary radio would also have to consume very little power.
2.5 The network bridge attempted by AMPRNet Sweden
The network bridge that was constructed for the experiment that AMPRnet Sweden carried out during the emergency preparedness day on Vaxholm Fortress consisted of four nodes, of which two were intermediary and battery powered. SK0MT acted as the AMPRnet base and Vaxholm Fortress as the remote network to bridge to. The intermediary nodes were used to establish a line-of-sight connection between the base and the remote network, and were placed on two elevated sites; on top of the Ullna land fill and the roof of Rindö Redoubt. Most of the distance of the network bridge lie between the two intermediary nodes, which are separated by 15 km. SK0MT and the Ullna landfill are 4 km apart, and Rindö Redoubt and Vaxholm Fortress a mere 500 meters.
Figure 2, geographical location of the SK0MT—Vaxholm Fortress network bridge
The radio mast used by SK0MT is 40 meters tall and has a line-of-sight to the 60meter high Ullna landfill. Rindö Redoubt is elevated 32 meters above water level, according to topographical data from topographic-map.com [10].
7

The terrain between SK0MT and the Ullna landfill is primarily low suburban housing, and the terrain between the landfill and Rindö Redoubt consists of mostly wood, open fields, some stretches of water and a few buildings. Rindö Redoubt and Vaxholm Fortress are separated by some trees and open water.
Figure 3, 3D renditions of the Ullna landfill, Rindö Redoubt (foreground, right) and Vaxholm Fortress (background, left) from Google Maps
2.6 Technical description of the battery-driven radio node
The Ubiquiti “Nanobridge” were used for the microwave radios that connected the radio nodes, which according to the Ubiquiti sales site has a range of more than 50 km in line-of-sight conditions [11]. Since these radios are highly directional, each intermediary node was equipped with two Nanobridges. A 150-ampere hour 12-volt lead-acid battery powered the node, connected via a voltage regulator that also steps the voltage down to lower values for other loads. Such loads could include a Wi-Fi access point, which would allow users at an intermediary node to connect to the network.
Figure 4, technical components of intermediary network node
The Nanobridges draw 2 ampere each, which meant a continuous consumption of around 48 watts. A connected solar panel could charge the batteries via the voltage regulator, and the current battery level could be read by the regulator firmware [12].
8

3 Method
This chapter will describe the chosen methodology, and how it was used to construct a method for solving the problem of finding a suitable radio link technology for the remote controlled electric switch system.
3.1 The design-science research methodology
The method chosen for this project is based upon the Design-Science methodology that is described in the paper “Design Science in Information Systems Research” by Hevner, March, Park and Ram [1].
The basis for the methodology is the build-and-evaluate cycle, where a design artefact (such as a system prototype or a theoretical model) is developed to solve a problem, and then thoroughly evaluated to prove its usefulness.
Hevner et al propose that “knowledge and understanding of a problem domain [in information systems] and its solutions are achieved in the building and application of [a] designed artefact” [1, p. 75]. They put an emphasis on using the act of designing an artefact as a way to explore the problem to be solved, i.e. by figuring out how one part of the artefact should be implemented, a corresponding part of the problem can be solved.
Additionally, they claim that the produced artefact must be useful as well as innovative in the problem domain, in order for the research to be contributing something of value, by either solving the problem in a new way or in a more efficient way than before.
To achieve these goals, Hevner et al present a set of guidelines that they recommend design-science researchers to use [1, p. 82];
1. Produce an artefact that works functionally. 2. Attempt to solve a problem that would be useful to an interested party. 3. Evaluate the designed artefact thoroughly to prove its usefulness. 4. The artefact must be innovative, by either solving the problem in a novel
way or by being more efficient than its predecessors. 5. Both the development and the evaluation of the artefact needs conducted
scientifically, by applying existing proven theories. 6. The problem should be solved iterating through several build-and-
evaluate cycles: a. The problem should be formally defined using the theories of the problem environment, so that the solution space can be explored by attempting to develop an artefact that solves the problem. b. By evaluating the resulting artefact, a better understanding of the problem can be achieved. The problem can then be more specifically defined, and a better artefact developed.
9

7. Communicate the research results from both a technical and business oriented perspective, so that the value of the research is clear to both technical and managerial audiences.
The authors encourage researchers to use as many of these guidelines as applicable, to conduct efficient design-science research.
3.2 Applying the methodology to this study
The problem that this study attempted to solve was finding a radio link technology that could meet the requirement of a 15 km line-of-sight communication range while consuming little power. Since this could be used to aid Swedish emergency preparedness of telecommunication, the problem is relevant (guideline 2).
By applying the link technology to a specific problem scenario (Täby-Vaxholm), a kind of case study is achieved, where insight in the performance of the technology in that specific scenario can be found (guideline 4).
A literature study was carried out to find a candidate radio link technology to use in the problem scenario of Täby-Vaxholm, that had been proven to work in similar environments. Related studies using that technology was then found to act as a basis for finding design parameters (guideline 5).
The Täby-Vaxholm scenario was then formally defined in terms of radio nodes and the link budget between them, to determine the transmission capability requirements on the link technology. The design parameters for the chosen radio link technology was then found, and its relation to the link budget formulated mathematically (guideline 6a).
Suitable values for the design parameters were found, and a mathematical model of the system was formulated. A prototype transmitter-receiver pair was then instantiated and configured to use the parameter values (guideline 1).
The prototype pair was evaluated by sending a transmission of groups of data packages and measuring signal strength and package loss at varying kilometre distances (guideline 3), and its results used to try and prove the correctness mathematical model of the system.
A simulation using the model of the system was done in the Täby-Vaxholm scenario using terrain data, to show that the system would meet the transmission requirements. By comparing the measured data to the expectations given by the mathematical model, the correctness of the model and the simulation can be evaluated (guideline 6b).
The introduction and background chapters of this report presents the relevancy of the problem to a non-technical audience, and is followed by a more technical description of the work in the following chapters (guideline 7).
10

3.3 Literature study
A literature study was made to decide upon a radio link technology to use in the system, focused on low-power wide area network (LPWAN) link technologies. LPWAN was selected because of its focus on energy efficiency and long range.
After selecting a LPWAN-brand, in this case LoRa, the literature study focused on the characterizations its parameters to understand what affects its performance.
3.4 Prototype system design
The design of the prototype system consisted of selecting a radio link technology, a data processing unit (such as a microcontroller or an application-specific integrated circuit) and an antenna that were suitable for achieving the goal of lower power consumption in the radio node.
The link technology and antenna was chosen to together support a transmission range of 15 km, and the data processing unit selected to be energy efficient. The LoRa transceiver has several configurable parameters, which were adjusted to maximize the range.
To evaluate the suitability for the link technology in the electrical switch system, the radio performance was to be measured with three quantities; received signal strength indication (RSSI), signal to noise ratio (SNR) and packet delivery ratio (PDR).
The software was designed specifically for field testing, where two radio units could communicate with a series of packets of a fixed size, and RSSI, SNR and PDR could be measured.
3.5 Implementation of hardware
The ‘Discovery’ development board for the STM32L152 microcontroller was selected as data processing unit, for its low power consumption and the familiarity of the implementers with the platform. Additionally, the development board had a built in LCD display suitable for feedback to a radio unit operator during tests.
HOPE Microelectronics RFM96 radio chip was used as LoRa transceiver, and was selected because of its affordability and availability as a breakout board easily connected to the Discovery development board.
In order to minimize the number of additional components needed at each radio node, it was decided to attempt the implementation with a single omnidirectional antenna instead of a directional antenna (which would require several antennas in the node).
11

3.6 Implementation of software
The software was based on LoRa drivers written by Sandeep Mistry for the Arduino brand of microcontroller development boards [ref]. The drivers were partially ported to the STM32 microcontroller, and used to configure radio parameters, transmit and receive packets, and extract RSSI and SNR values from the LoRa transceiver chip.
Additionally, software was written to measure the PDR and to give a user interface for the field testing to configure the number of packets to send. To measure RSSI, SNR and PDR, several packets were sent in groups of 10, 100 or 1000 row to be able to gather statistics of the measurements.
By basing the software implementation on an existing library, development time was shortened, and focus could be put on the evaluation of the link technology.
3.7 Test of prototype system
When the implementation of a transmitter unit and receiver unit was completed, a short test was performed indoors to verify that they could communicate with each other.
A statistical function was used in the software to calculate mean and standard deviation of SNR and RSSI, and was verified for correctness by comparing test data to output from the math software Mathematica.
The field test was carried out by standing with transmitter and receiver on tall bridges in central Stockholm separated by a couple of kilometres, to be able to measure radio performance at longer distances with a free line-of-sight between transmitter and receiver.
The collected data was then to be consolidated and used to create a model of the signal strength as a function of distance, to determine if the system could receive packets at the desired distance of 15 km using LoRa with the configured parameters.
Additionally, a simulation of the performance was made based on the receiver signal strength sensitivity that had been calculated for the parameters in the actual problem scenario with consideration for terrain.
12

4 Literature Study
The previous chapter presented the method for the study, where the first step was to determine what link technology to base the remote-controlled electric switch system on. This chapter will present the findings of the literature study that was made, and its conclusion to use the LoRa-brand technology.
Low Power Wide Area Networks (LPWAN) is a type of network that the Internet of Things (IoT) research community has shown interest in [ref], and because of the electric switch systems similar power constraints and range requirements to IoT-devices, was chosen as the topic for the literature study.
The goal of LPWAN technologies is to achieve connectivity between powerconstrained devices in a wide area, such a house or a neighborhood or a city [ref], and does this by significantly lowering the communication data rate of the devices.
As a basis for the literature study, the paper “Low Power Wide Area networks: An Overview” by U. Raza and P. Kulkarni was used [13]. In the paper, they present the design goals and techniques of different LPWAN technologies, and discuss their similarities and differences to each other. Interesting technologies mentioned in that paper were then further researched individually.
The LPWAN technologies that were considered for the electric switch system was Ingenu Ramp, SigFox, LoRa and Telensa, presented here in alphabetic order. The chapter ends with a discussion of the technologies, and the selection of one of them.
4.1 Ingenu Ramp
In the LPWAN-market, a fairly new growing technology is a company called Ingenu Ramp. One major reason is their spread spectrum method, which is different from other LPWAN technologies, they use Random Phase Multiple Access (RAMP) to operates in 2.4 GHz ISM bands (which means that IEEE 802.11 used as media access control protocol and physical layer), this providing more relaxed spectrum usage rules and at the same time no architecture changes is required for sub-GHz technologies i.e. That Ingenu Ramp can be easily integrated with existing networks.
Another reason is that other company’s such as LoRa and SigFox are more designed for smaller packet size delivery then Ingenu Ramp, but they fail to have enough capacity or distance to build a cost effective wireless network model compare to Ingenu Ramp. [14]
For uplink communication, Direct Sequence Spread Spectrum (DSSS) is used for multiple access points. This kind of transmission technology is usually used in
13

local area, and benefits are resistance to jamming, sharing signal channels among multiple users, and less background noise.
For downlink communication, a modified Code Division Multiple Access (CDMA) is used, that allows multiple transmitters to share on a single time slot. However, RPMA extends the traditional time slot for CDMA, so that access for each channel gets a random delay for each transmitter. By not giving the transmitter direct access to channels, which reduce the overlap between transmission signals while increasing the signal in interference ratio for each individual link. This allows for more robust transmission control and higher sensitivity capabilities, better general coverage, and optimum battery life use. [13, p. 8]
4.2 LoRa (Long Range)
A relatively new technology that promises energy efficient long-range communication is LoRa, which falls under the category of Low-Power Wide-Area Networks (LPWAN). LoRa was developed by the French company Cycleo, that was later acquired by the California based company Semtech, and is marketed as an enabler for the Internet of Things (IoT) [15].
LPWAN achieves low power consumption and long range in exchange for lower data rates between devices and network gateways, which can extend the battery life of power constrained devices like those found in IoT and sensor networks.
LoRa consists of a proprietary physical layer modulation scheme (“LoRa”) and an open media access protocol called LoRaWAN. The physical layer LoRa is based on a spread spectrum modulation technique called Chirp Spread Spectrum (CSS), where data symbols are encoded in tones that sweep either up or down in frequency.
Figure 5, LoRa up- and down-chirps in the time domain
During encoding, the carrier frequency of the signal is repeatedly swept either up or down, which generates so-called up-chirps and down-chirps. Being a spread spectrum technique, it utilizes the entire allocated transmission bandwidth to broadcast, which makes it robust to signal noise. Additionally, since the symbols are encoded with a continuously changing frequency, the transmission is also resistant to fading caused by the Doppler effect.
The three primary user-configurable parameters of LoRa are Bandwidth (BW), Spread Factor (SF) and Code Rate (CR). Bandwidth determines the speed at which the chirps are sent, and spread factor determines how many chirps are
14

used to encode a single bit, with higher SF yielding slower data rate but more reliable signal (with available values between 7 and 12). [16, p. 2]
Code rate is used to determine the ratio between payload bits and errorcorrecting redundant bits (usually a ratio of 4/8) that makes the transmission more robust. These parameters will be further explained later in the Theory & Design chapter.
In studies carried out to characterize LoRa, empirical data has shown that commercially available LoRa radio chips are capable of at least 30 km line-ofsight communication [2][4].
4.3 SigFox
The French company SigFox is another relatively new technology that falls under the category of Low-Power Wide-Area Networks (LPWAN). SigFox is one of the world’s leading IoT-service providers of energy efficient devices, such as wireless indoor temperature meters, alarm sensors, Arduino and etc. [17]
SigFox consists of a proprietary physical layer that is based on ultra-narrow band (UNB) technology and a media access protocol called Random Frequency and Time Division Multiple Access (RFTDMA). [18]
SigFox is cellular, and uses a star topology with nodes connected to in average three SigFox base stations. The base stations are connected to SigFox IoTnetwork, which provides a associated cloud service for data processing. [19]
There are several advantages to use UNB’s property to increase the distance of the signal; one reason is UNB receivers listen to only a small part of the spectrum and therefore capture less noise, which in turn leads the signal to reaching longer. Another advantage of UNB is that a receiver uses a step filter that efficiently interrupts sideband disturbance.
During transmission, the broadcaster uses binary data to encode with a differential binary phase shift keying (DBPSK) modulation at a very low rate, and then SigFox’s nodes uses a RFTDMA to forward the signals. Additionally, frequency hopping spread spectrum (FHSS) is used to provide multiple access points, and ensures channel diversity by transmitting three times for each device on different and randomly selected UNB channels and this also gives protection against deep fading.
For reception, Gaussian Frequency Shift Keying (GFSK) is used. GFSK allows the user to filter data pulses with a Gaussian filter to make the transmission smoother and reduce side band power, and reducing the interference of nearby channels due to inter-symbol interference (ISI). ISI is a signal distortion in telecommunications and occurs if one or more symbols cause noise or less reliable signal. Multiple propagation and nonlinear frequencies in channels are the main cause.
15

SigFox has been characterized with a transmission range in urban areas of 10km and in rural areas of 30km. [13, p. 7]
4.4 Telensa
A less widespread fairly new technology that promises energy efficient longrange communication is the company Telensa. They focus more on developing wireless smart house control system and is one of the world’s leading manufacturers in the area; intelligent street lighting solution. The company uses something called PLANet to communicate with central management system (CMS) and outdoor device networks (ODN).
Telensa has chosen to collaborate with the TALQ consortium, which is a company that is working with implementing a global acceptance standard for management software, to be able to control and monitor outdoor device. The goal is to enable interoperability between (CMS) and (ODN) from different providers, so that only CMS can control some ODN in different parts of a city, or region depending on the populations regulatory needs of lighting or other requirements. [20]
The physical layer consists of bi-directional ultra –narrow band (2-UNB), which operates in unlicensed sub GHz ISM band(in EU 868 MHz, US 915 MHz and Asia 430 MHz), and has an uplink of 62.5bps and downlink of 500bps, besides this, not much information exists about implementing the technology. [13, p. 8]
4.5 Suitability for the technologies in the prototype
A technical presentation of the different brands of LPWAN has been presented, and will be compared in this section to each other and considered for the remote-controlled electrical switch system.
Ingenu Ramp is suitable for areas already integrated into telecommunication infrastructure such as smart gate connectivity, intelligent lighting, and oil and gas automation. Ingenu Ramp does however rely on a private cellular network, and is therefore not suitable for crisis preparedness, where technologies need to be independent from the infrastructure that they are supporting.
LoRa is available both as a network-technology (LoRaWAN) and a radio link technology (LoRa physical). LoRaWAN is based upon LoRa physical and is proprietary and cellular, which makes it unsuitable for the same reason as for Ingenu Ramp. The LoRa physical technology can be used independently of the WAN, and LoRa can therefor offer the long range and lower power consumption required for the electrical switch system.
SigFox, similarly to Ingenu Ramp, uses a cellular network to connect devices via base stations. Since these base stations are part of a proprietary network service owned by the SigFox Company, it is unsuitable for the same reasons as Ingenu Ramp.
16

There was very little information found about Telensa in the literature study, and seems less widely used than the other technologies. It was there for difficult to find details about Telensa could be used practically in the project, and whether or not it was suitable. Because of that, Telensa was not chosen for the prototype.
Although SigFox showed good range properties, and as such could be a candidate for the radio link in the electrical switch system, it is cellular and therefore could not be used in the multi-hop network topology chosen for the project.
Since LoRa has a 30 km line-of-sight range, and had off-the-shelf radio transceivers available, it was selected for the project.
4.6 Related LoRa studies
This section will summarize three papers written about attempts at characterizing LoRa that were found in the literature study conducted at the start of the project.
The first was carried out in the Antarctic, and focused on a line-of-sight condition, and the other two in Europe. One was done in Spain, were three different environments were considered (rural, suburban and urban), and the last in Finland in an urban environment and on water.
4.6.1 LoRa Mobile-To-Base-Station Channel Characterization in the Antarctic
Gaelens, Van Torre, Verhaevert and Rogier examined a LoRa radio link between a base station with a directional antenna and a mobile vehicle equipped with an omnidirectional antenna in the Antarctic, to determine the suitability for LoRa technology in Polar Regions.
The experiment was done using the Microchip DM164138 development board, equipped with a Microchip RN2438 LoRa transceiver, at both base station and mobile vehicle. The LoRa parameters were configured to 125 kHz bandwidth, 4/5 code rate and a spread factor of 12.
The base station was equipped with a 9-13 dBi gain directional antenna, and an omnidirectional antenna on the receiver. They transmitted 3-byte payloads at +14 dBm on both the 434 and 868 MHz bands, and measured received SignalNoise-Ratio (SNR) and Packet Delivery Rate (PDR) at the mobile vehicle. The maximum range that was achieved was 30 km, with no package loss at all up to 25 km LoS.
The authors conclude the paper by stating that line-of-sight is an essential requirement for long range LoRa links, and that terrain elevation is the dominating factor that influences the reception. Additionally, they also state that their calculated link budget of 154 dBm implies that omnidirectional antennas could be used for both transmitter and receiver [2].
17

4.6.2 Range Evaluation and Channel Attenuation Model for LoRa Technology
Petäjäjärvi, Mikhaylov, Roivainen and Hänninen conducted a study of LoRa in the finish city of Oulu on both ground, with the receiver on the roof of a car, and on water mounted on the radio mast of a boat, with the goal of determining the coverage of a commercially available LoRa transceiver.
They used a Kerlink IoT station as base station with a 2 dBi gain biconical antenna mounted on the University of Oulu’s antenna tower at an altitude of 24 meter from sea-level, and a LoRaMote equipped with a Semtech SX1272 transceiver as receiver.
The LoRa parameters were set to a bandwidth of 125 kHz, spread factor of 12 and an unspecified code rate value. Transmission was done using +14 dBm power on the 868 MHz band with frequency hopping on 6 channels (which increases robustness to interference). The payload size was unspecified.
Using a car moving around in the urban environment of Oulu, they achieved over 80% PDR at distances up to 5 km, 60% PDR between 5 km to 10 km, and a majority loss after 10 km. On water, the PDR was 70% at a distance of up to 15 km, with the maximum range with successful deliveries at 30 km [3].
4.6.3 Performance Evaluation of LoRa Considering Scenario Conditions Sanchez-Iborra, Sanchez-Gomez, Ballesta-Viñas, Cano and Skarmeta did a more throughout study of LoRa characteristics by taking into consideration different kinds of environments, and trying to find optimal LoRa settings for each one.
They used an Arrow SmartEverything Fox development board as receiver mounted on the roof of a car, and used a Rising HF RHF2S008 development board equipped with a Semtech SX1301 LoRa transceiver as base station. The base station transmitted on the 868 MHz band at 14 dBm and had an 8 dBi gain sectorial antenna, and the receiver a 5 dBi gain omnidirectional antenna.
Prior to performing any real-life measurements, simulations of the system were done using the web-based service CloudRF, which gave a reference point for the experimental results [4].
The measurements were done in an urban, suburban and rural scenario in and near the Spanish city of Murcia. They used many combinations of different BW, SF and CR parameter settings to determine their impact on received signal strength and delivered package ratio.
The greatest distance that was achieved was 18.5 km in the rural scenario (which means less obstruction) using a spread factor of 12. The package delivery rate was observed to depend somewhat on the payload size, with smaller packages being delivered more reliably than bigger ones.
18

In the discussion chapter of the paper, they state that the best parameter configuration for optimized length is setting SF and CR to their maximum values, 12 and 4/8 respectively. 4.6.4 Summary of related studies These three examinations of LoRa capabilities have all shown that the technology can be used to reach 10-30 km, using different commercially available LoRa transceivers in different scenarios. Common to all of them is the use of a high code rate and spread factor, and obstruction free line-of-sight conditions. The result from these studies suggests that a LoRa transceiver could be used as radio channel in the electric switch system for the SK0MT—Vaxholm network bridge nodes, as long as a line-of-sight can be guaranteed, and proper antennas are used. One important difference between this work and the ones mentioned is that the LoRa radios used for the electric switch system needs to be able to act as both transmitter and receiver due to multi-hopping between nodes in a chain. This implies that the antenna used for transmitter and receiver needs to be the same. This study therefor examined how a LoRa channel using omnidirectional antennas performs, since this allows each electric switch equipped network bridge node to function with only one additional antenna.
19

5 Radio Link Theory
In this chapter, a simple model of the transceiver’s capabilities will be constructed, suitable LoRa parameters selected and an estimation of the systems communication range with those parameters given.

5.1 Transmission theory
One of the design aspects that haven’t been discussed yet is the particulars of the LoRa transceiver, the mechanisms that influence its communication range and the parameters that can be configured by the designer. This section therefor will introduce some fundamental transmission theory, that will later be applied to the SK0MT—Vaxholm scenario to determine the systems theoretical capabilities.

All formulas and theory presented in this chapter is based on descriptions found in the book “Wirless Communication & Networks” by Beard & Stallings [21].

5.1.1 Link budget and fading
The link budget is an expression of the relation between received signal strength, transmitted signal strength, and any system gains and transmission losses involved.

The logarithmic formula for the link budget is:

 [] =  +  −  + 

(1)

where  and  are the system gains of transmitter and receiver (from antennas),  and  are the transmitted and received power and  the sum of all involved losses (cables, propagation loss).

Fading is a significant part of the transmission losses in real life scenarios, and is an expression for the variation in signal strength due to interference when a transmitted signal is scattered on terrain and obstacles (multipath fading), or due to obstruction blocking the signal (shadow fading).

The lowest signal strength that can be detected is called the receivers sensitivity, and the amount by which the signal strength exceeds that sensitivity is called the fading margin.

5.1.2 Free space propagation loss
When a signal is propagating in the space between two antennas, the radio energy becomes more and more spread out geometrically. This causes a loss in signal strength related to the distance squared, as expressed by Friis transmission equation:

4π 2

(2)

 = (  )

20

with  as the wave length of the carrier wave, and  as the distance between the transmitting and receiving antenna in the same unit as the wave length. The free space path loss can also be expressed logarithmically as:

4π  [] = 20 log10 (  )

(3)

5.1.3 Okumura-Hata model for propagation loss
Real life broadcasting scenarios introduce fading onto the signal, which introduces much greater losses than would be predicted by the free space propagation loss.

There are sophisticated ways of carefully calculating the exact impact of fading in a particular scenario with techniques such as ray tracing, which are complicated and out of the scope for this text. As an alternative, models of fading based on empirical data can be used.

The Okumura-Hata model is a widespread such empirical data based model, and formulates an expression for the losses a signal experiences in urban, suburban and rural scenarios [22]. The estimated loss for an urban scenario of a mediumsized city is given by:

 [] = 69.55 + 26.66  log10  − 13.82 log10 ℎ − (ℎ)

+ (44.9 − 6.55 log10 ℎ) log10 

(4)

(ℎ) [] = (1.1 log10  − 0.7)ℎ − (1.56 log10  0.8)

(5)

where:

ℎ = height of transmitting antenna in 30–200 meters

ℎ = height of receiving antenna in 1–10 meters

(ℎ) = correction factor for receiver antenna height in decibel



= carrier frequency in 150–1500 Megahertz

 = total distance between antennas in kilometers

For a suburban scenario, the urban model is modified to account for the lesser

amount of obstruction:

 2

(6)

 [] = Lurban − 2 (log10 28) − 5.4

and for the rural scenario, further subtractions are made from the loss predicted in the urban scenario:

 [] =  − 4.78(log10 )2 + 18.33 log10  − 40.94 (7)

21

5.1.4 Fresnel zones
Two types of fading have been described; multipath fading and shadow fading, that both depend on obstruction in the propagation path. The Fresnel zones are geometric expressions for the area where an obstacle would interfere with the signal.

Figure 6, illustration of first Fresnel zone
The Fresnel zones are cigar-shaped elongated ellipsoids placed between the transmitting and receiving antenna. If part of the transmission collides with an obstacle in a Fresnel zone, it will be reflected back slightly phase-shifted, causing signal attenuation at the receiver due to destructive interference with the nonreflected wave.
Each numbered zone forms a shell outside the previous and introduces an amount of phase shifting, with the first zone shifting the reflected signal by 0– 90º, the second zone surrounding the first and phase shifting by 90–270º, the third shifting by 270–450º, increasing by 180 º for each subsequent zone.
The radius  at a point p on the surface of a particular zone is expressed by:



=

 λ √
1

12 + 2

,

1, 2 ≫  λ

(8)

where: n = Fresnel zone number

λ

= wavelength of carrier wave

1 = distance from transmitter to point p in meters 2 = distance from receiver to point p in meters

Note that higher frequencies will have shorter wave lengths, and by effect, more concentrated Fresnel zones. Lower frequencies in turn result in larger Fresnel zone, which increases the likelihood of obstruction in the propagation path.

By doubling the frequency, the wave length is halved, and Fresnel zone radius decreases by a factor of √2 as is made clear by the expression:

(2f0)

=

√

λ0 2

12

1+2

=

1 √2

√λ012
1+2

=

1 √2

(f0)

≈

0.71(f0)

(9)

22

When selecting the frequency for the system, care should be taken for the resulting Fresnel zone radius. However, as has been shown in Equation (9), frequencies that only differ in one octave have very similar radii.
According to Westcott and Coleman [23], the rule of thumb for Fresnel zone clearance is that the first zone should ideally be 80% clear of obstacles, but at the very least 60% clear of obstacles.

5.2 ISM-band regulations
LoRa transceivers usually operate on the license free Industrial, Scientific and Medicinal (ISM) frequency band for transmission. This band is free for anyone to use, but have regulated transmission powers and duty cycles (how often a device is allowed to transmit expressed as percentage of an hour).

The specific frequencies that are considered license-free ISM depends on the local regulatory agency. In Sweden, the PTS determines the regulation of radio transmission and which frequencies constitute ISM. An excerpt from the ISMband regulation from PTS [24] is found in Table 2:

Table 1, PTS regulations of some license free frequency bands

Frequency band (MHz) Maximum power

433,05–434,04

10 mW e.r.p

868–868,6

25 mW e.r.p

868,7–869,2

25 mW e.r.p

Duty cycle 10 % 1.0 % 0.1 %

Effective radiated power (e.r.p) is a measurement of the transmitted power after account for cable losses and antenna gain. Note, that if a directed antenna is used instead of an omnidirectional, that same input power to the antenna will be amplified in a single direction, which increases the e.r.p. Care must therefore be taken when selecting high gain antennas with respect to regulations.

The 433 MHz and 868 MHz bands were the most common bands used by LoRa applications during the writing of this report, and differ only by one octave. As was mentioned in the previous section, this means that they have similarly sized Fresnel zones. Regulatory aspects might therefor be more important to take into consideration than Fresnel zones when choosing the frequency for the system.

5.3 LoRa parameter configuration
To finish the theoretical framework needed to determine the theoretical communication distance of the LoRa system, the configurable parameters of LoRa will now be presented based on descriptions given by Bor and Roedig [16].
This section will be concluded with a derivation of the sensitivity of the system based on the discussed parameters.

23

5.3.1 Spread factor
The spread factor (SF) is the ratio between the number of LoRa chirps (henceforth chips) that encodes a single data bit (symbol ), and is expressed by:

ℎ   = 2

(10)

Higher spread factor values increase the signal-to-noise ratio of the transmission, at the cost of increased air time and energy consumption per data packet. The spread factor can be chosen as an integer value between 7 and 12.

Different spread factors are orthogonal to each other, which means that transmissions using different SF values don’t interfere with each other.

5.3.2 Bandwidth
LoRa is a spread spectrum modulation technique, where transmitted signals occupy a wider frequency band than the baseband of the data signal.

Figure 7, illustration of different bandwidths with the same center frequency
The bandwidth parameter determines how much the up and down chirps will be swept, and directly determines how fast chips will be sent. A bandwidth value of e.g. 125 kHz corresponds to chip rate of 125 kilo chirps per second.
LoRa BW values can take on discrete values between 7.8 kHz and 500 kHz in steps of doubling frequencies, with usual values being 125 kHz, 250 kHz and 500 kHz.
5.3.3 Code rate LoRa employs forward error correction (FEC), where redundant data is encoded onto a data package to repair packages whose bits were corrupted due to burst interference.
Figure 8, illustration of packet with CR = 4/6
The code rate expresses the ratio between the number of payload bits and the combined payload and error correcting bits, taking on values of 4/5, 4/6, 4/7 or 4/8. Higher CR values offer more protection, but increases package size and as a consequence transmission air time.
24

5.3.4 Data rate and transmission air time
The rate at which payload is being transmitted is dependent on all three LoRa parameters BW, SF and CR. The Semtech “LoRa Modulation Basics” application note [25] derives the nominal data rate  and expresses it as:

   

 =  (2 ) =

2

/

(11)

The data rate is proportional to the bandwidth, and inversely proportional to the code rate (which is always less than one) and the spread factor. As the data rate increases, the transmission time naturally decreases.

Determining the exact air time for a data packet depends on SF, BW and CR, as well as the number of chips in the preamble, packet header size and payload size. To reduce air time, an implicit header can be used where the header data is omitted if transmitter and receiver know its content a priori.

Air time is important when respecting duty cycle regulations. The longest air time for a packet with payload PL of 2 byte, default 6 preamble symbols and implicit header is obtained with SF =12, CR =4/8 and BW =7.8 kHz. That air time is calculated according to the LoRa Modem Design Guide [26].

Period length for a single symbol:

2

212

 =  = 7.8 × 103 = 0.525 sec

(12)

Period length of the packet preamble:

 = ( + 4.25) = 10.25 × 0.525 = 5.381 

(13)

Number of symbols  for a payload with implicit header:

8  − 4  + 28 + 16 − 20 4

 = 8 +  (⌈

4 

⌉  , 0)

(14)

8(2) − 4(12) + 28 + 16 − 20 4

 = 8 +  (⌈

4(12)

⌉ 4⁄8 , 0) = 8

(15)

This then gives the period for the payload:  =  ×  = 8 × 0.525 = 4.2 

(16)

25

Finally, the period of the packet:

 =  +  = 5.381 + 4.2 = 9.58 

(17)

The most stringent duty cycle restriction was for the 868,7–869,2 MHz band with 0.1%, or 3.6 seconds per hour. The 9.58 second air time calculated above would violate the duty cycle limit for that frequency band.

For the 868–868,6 MHz and 433,05–434,04 MHz bands there is a duty cycle limit of 1% and 10 % respectively, or 36 seconds per hour and 360 seconds per hour. The air time of the calculated package therefor complies with requirements in both of these bands.

By doubling the bandwidth, the air times are halved. In order to be able to send packets more regularly, calculating the necessary bandwidth to still comply with regulation becomes simple; doubled bandwidth equals doubled allowed packets.

5.3.5 LoRa sensitivity
The sensitivity of the LoRa transceiver determines the maximum distance where communication can still function, and depends on the spread factor, bandwidth and code rate. According to the LoRa Modem Design Guide [26], the sensitivity  is given by:

 [] = −174 + 10 log10  +  + 

(18)

where −174 + 10 log10  is the noise floor, NF is the noise figure of the receiver electronics and SNR the signal-to-noise ratio. According to the Lora
Basics application note [25], the noise figure has the value 6 dB. This leaves the
SNR as the unknown quantity to calculate.

The signal-to-noise ratio can be derived from the Shannon-Hartley theorem that expresses the theoretically highest possible data rate  in a noisy channel:

 =  log2(1 + )

(19)

If the signal-to-noise ratio is much smaller than 1, the value of the logarithm will be in the interval 0 to 1 and can be linearly approximated to:

  ≈  ×  ⇔  ≈ 

(20)

The capacity  for the LoRa transceiver was calculated earlier in Equation (11) as .

26

By inserting it into Equation (21), the following SNR expression is obtained:

       ≈  = 2  = 2

(21)

Finally, the sensitivity is expressed as:

   [] = −168 + 10 log10  + 10 log10 ( 2 )

(22)

Some empirically defined LoRa transceiver sensitivity values given from Semtech for parameter values BW=125 kHz and CR=4/5 are found in Table 3.

Table 2, LoRa sensitivity values for different spread factors

Spread factor

Sensitivity (dBm)

12

-137

11

-134.5

10

-132

9

-129

8

-126

7

-123

The value for SF=12 in Table 3 can be compared to the sensitivity formula that has been derived:



[]

=

−168

+

10

log10(125

×

103)

+

10

log10

12 (

× 4/5 212 )

 [] = −168 + 50.97 − 26.30 = −143.33

(23) (24)

The calculated value differs from the tabulated value by about 6 dB. In Figure 3 in the LoRa Modulation Basics paper, the theoretical and empirical sensitivity is plotted with a 6 dB difference, which suggests that the noise figure is 12 dB rather than 6 dB and that the calculations done match the theoretical sensitivity.

Calculating the sensitivity for the parameter values CR=4/8 and BW=7.8 kHz and using NF=12 instead gives:



[]

=

−162

+

10

log10(7.8

×

103)

+

10

log10

12 (

× 4/8 212 )

= −151.42

(25)

Based on the theory presented in this section, the lowest LoRa sensitivity possible is −151.42 dBm, as calculated in Equation (25).

27

5.3.6 Selection of LoRa parameter values for RC electric switch system
This LoRa parameter section will be concluded by selecting the parameter values to be used in the electric switch system with the goal of maximising reliable communication range for infrequent packets (see Table 4).

Table 4, LoRa parameter settings

Parameter

Value

Spread factor

12

Bandwidth

7.8 kHz

Code rate

4/8

Frequency

433 MHz

Transmission power 10 dBm e.r.p

Motivation Highest signal-to-noise ratio Slow signal gives better sensitivity Best protection against burst interference ISM-band the with least propagation losses Highest allowed power in 433 MHz band

5.4 Theoretical communication range
This chapter will be concluded with a calculation for the ideal theoretical communication range for a LoRa transceiver in the SK0MT—Vaxholm Fortress scenario using the parameters chosen in Table 4.

To comply with regulation, the effective radiated power is set to 10 dBm, which is expressed symbolically as:

 =  +  +  = 10

(26)

where  is the power fed to the antenna,  is the antenna gain and  is the cable loss. The link budget expression in Equation (1) with the chosen
parameters then becomes:

 =  −  +  = 10 −  + 0

(27)

The propagation losses will be modelled using Okumura-Hata, receiver gain  assumed to be at unity (0 dBi) and assuming no cable losses.

5.4.1 Link between SK0MT and Ullna landfill
The terrain between the radio club and the Ullna landfill consists of low housing, and can therefore be modelled using the suburban Okumura-Hata model. The transmitter is the radio club with a radio mast with height 40 m, and the receiver on Ullna landfill is elevated 60 m.

Figure 9 shows a plot of the received power at varying distances. Due to the limits of the Okumura-Hata model, the receiver height was set to 10 m. At 4 km, the received power is -107 dBm which gives a fading margin of 44 dBm.

Since the receiver at the Ullna landfill is elevated 60 m rather than 10 m, the received signal strength should be much higher, and the link should be very strong.

28

Figure 9, received power at varying distances from SK0MT using Okumura-Hata suburban model
5.4.2 Link between Ullna landfill and Rindö Redoubt The terrain between the landfill and Rindö Redoubt consists of mostly open fields, wood and stretches of water. The propagation loss is therefore modelled using the rural Okumura-Hata model, with the transmitter at 60 m and the receiver again at 10 m due to the limitations of the model.
Figure 10, received power at varying distances from the Ullna landfill using Okumura-Hata rural model
At 15 km, the received signal strength is -121 dBm, which gives a fade margin of 30 dBm. Again, since the receiver will be elevated at 40 m instead of 10 m the received signal strength should be higher than estimated by this model. For both of the links, large fade margins have been estimated.
29

6 Implementation of Prototype
This chapter documents the implementation that was made of the experimentprototype used for measuring the LoRa transceivers performance. First, the selected components and their assembly will be presented. Then, an overview will be given of the software in the transmitter and receiver microcontroller using flowcharts. Finally, code snippets for collecting RSSI and SNR data will be shown, together with a validation of statistical functions used.
6.1 Goal of implemented prototype
Before any attempt at implementing the system proposed in the architecture section of chapter 2 was to be made, the suitability for using LoRa as a radio channel had to be established empirically.
The suitability was to be determined by implementing an experiment-prototype that could be used to measure the performance of a commercially available LoRa transceiver in a real life scenario.
To be able to draw a general conclusion from limited testing, the prototype would have to be able to gather data that could be extrapolated. Therefore, the following goals were set up for the experiment-prototype:
• Able to measure received signal strength (RSSI) of a received signal • Able to measure signal to noise ratio of received signal (SNR) • Able to measure the packet delivery ratio (PDR) at the receiver
6.2 Hardware components and assembly
The hardware architecture of the experiment-prototype that was implemented was a partial implementation of the one presented in chapter 2, omitting the Bluetooth module. The system consisted of one transmitter and one receiver, with a push button for user input and a segment liquid crystal display (LCD) for system feedback (see Figure 11).
Figure 11, block diagram of transmitter and receiver hardware
6.2.1 STM32L1-Discovery development board The STMicroelectronics STM32L152 microcontroller equipped Discovery development board was used in both the transmitter and receiver for all processing. The controller was selected because the implementers of the
30

prototype had prior experience with the STM32-controllers, shortening development time, and because it featured sophisticated power saving features. The STM32L-series of microcontrollers are tailored for use in battery driven systems, which makes it a good fit for the power constrained remote electric switch.
According to the STMicroelectronics sales site, the controller has low power modes with current consumption in the range of micro to nanoampere [27], which means the STM32L1 would be a very small load on the battery in the AMPRnet network bridge nod.
Although no power saving features in the software were explored, a low-power MCU was still selected with regards to further development of the system in the future.
The Discovery development board was used to speed up development, omitting the need for a dedicated printed circuit board (PCB), and was equipped with an inbuild LCD display, making the assembly of the prototype system simpler.
6.2.2 RFM96 LoRa radio chip The Semtech SX1276 LoRa transceiver equipped HOPE Microelectronics RFM96 radio chip was used for communication. Since no PCB was made, the Adafruit breakout board of the RFM96 was used to connect the radio chip to the microcontroller development board.
The data sheet for the RFM96 claim a 168 dBm maximum link budget, 20 dBm maximum output wattage, 127 dB range of Received Signal Strength Indication (RSSI) and a sensitivity of -148 dBm (3 dBm worse than the theoretical sensitivity calculated in section 5.3.5) [28].
On paper, the radio chip should manage to achieve the desired range of 15 km, and be able to give adequate data on the received signal strength at varying distances so that a model of the systems performance could be constructed.
6.2.3 Flexi SMA90 Quarter-whip antenna Since it was discovered that a thorough study of LoRa line-of-sight capabilities in the Antarctic had already been made for a directional antenna at the transmitter and an omnidirectional antenna at the receiver by Gaelens et al.[2], the experiment-prototype implemented in this project used an omnidirectional antenna for both the transmitter and receiver.
Gaelens et al. concluded their report by stating that data suggested the feasibility of using an omnidirectional antenna for the transmitter as well as receiver, which would allow the electric switch system in this report to add only a single additional antenna to the existing network bridge nodes.
The Flexi SMA90 quarter-whip antenna was chosen for the experimentprototype due to time constraints, because of its availability at short notice. No
31

gain was specified in the datasheet of the antenna. Since the antenna is a quarterwhip, it was estimated that the gain should be in the range of 0-3 dBi. No attempt was made to determine gain through experimentation. The antenna was connected to the RFM96 radio chip using a 150 mm long SMAto-μFL adapter cable. According to its datasheet [29], the cable loss per 100 m is 91.9 dB at 400 MHz, which gives the 150 mm cable used to connect the antenna a negligible attenuation of 0.14 dB. The cable matched the antenna impedance of 50 ohm, which meant little to no signal reflection from transmitter to antenna, and subsequently little to no signal power loss. According to the cable datasheet, the voltage standing wave relation at 433 MHz is equal to 1.52. Converted to reflection coefficient , it has the value of 0.21, where a value of -1 represent a short-circuited cable load, +1 an open-circuit at cable load and 0 no reflected signal. The cable loss due to attenuation and reflection was determined to be insignificant. 6.2.4 Assembly To assemble the components into the prototype hardware, the antenna was mounted onto a chassis made out of a half of a plastic enclosure. The radio chip was taped to the back of the Discovery development board and connected using soldered jumper wires (see Figure 12).
Figure 12, implemented experiment prototype hardware front and back. (Receiver on the left, transmitter on the right.)
32

The Discovery board and radio chip was then attached to the plastic chassis using simple rubber bands, and powered using a power bank via usb-port on the development board. The transmitter was color-coded red, and the receiver blue.
6.3 Transmitter and receiver software
The software written for the transmitter and receiver was tailored for taking measurements of RSSI, SNR and PDR in the receiver unit. A simple loop in the transmitter sent 2 byte packages containing increasing integer packet IDs, using a bandwidth of 125 kHz, code rate 4/8 and spread factor of 12. The receiver could be configured by the user to receive 1, 10, 100 or 1000 packages, and the receiver would then display data values on the LCD display after the transmissions were completed.
Figure 13, overview of transmitter and receiver software collaboration procedure
The bandwidth was selected to speed up the time the measurements would take, and to simplify comparisons of results from the related studies in section 4.6. This would then give an indication of the systems performance, so that a later test could be made using a bandwidth of 7.8 kHz. An overview of the procedure of the transmitter and receiver software is depicted in Figure 13, with both operator of the transmitter and receiver unit collaborating. The receiver operator selects the expected number of packages, and then instructs the transmitter operator to begin sending. When the expected numbers of packets have been received, the transmitter operator stops sending, and the receiver operator reads the resulting data on the LCD display.
33

6.3.1 LoRa driver The driver that microcontroller used to control the LoRa transceiver was based on a RFM96 library written by Sandeep Mistry for the Arduino brand of microcontrollers [30], partially ported to the STM32L1. The driver could configure the desired LoRa parameter values, and control transmission and reception of packets. This driver also extracted SNR and RSSI values from the RFM96 chip. 6.3.2 Transmitter unit’s microcontroller firmware The firmware of the transmitter was simpler than the receiver, since it only had to initialize the LoRa transceiver and then continuously transmit packets. Each packet was sent with a 2 byte integer payload representing the packet ID, with each subsequent packet incrementing the ID by one.
Figure 14, transmitter software flow chart
First, the microcontroller attempts to boot the RFM96 radio chip via its SPI interface. If no value is read from the RFM96 over SPI, the communication has failed, and there was an error in booting the chip. This was used to identify mistakes such as forgetting to connect a cable or connecting it to the wrong pin. If the boot was successful, the controller waits for the operator to press the button before continuing to the transmission loop. During transmission, the current ID of the transmitted packet is displayed on the LCD. This informed the operator of how many packets have been sent at the moment. There was a small delay set at the end of each transmission to increase the time the receiver could process received data. This was done to ensure that packets were not lost due to the receiver not listening, rather than interference and noise.
34

6.3.3 Receiver units’ microcontroller firmware
The receiver firmware consisted of three stages; initialization and setup, reception of packets, and data processing and presentation. As with the transmitter, the microcontroller first initializes its low level system functions, then attempts to boot the radio chip.

Figure 15, receiver software flowchart

A menu allows the operator to select the number of packets to expect from the transmitter with the user button, and then proceeds to the “receive packets”loop until the expected number of packets have been received.

The LoRa transceiver was configured to use forward error correction, so corrupted packets were discarded. Therefore, the packet delivery ratio could be calculated by comparing the received number of packets to the last packets ID as expressed by:

     

 =

    

(28)

The RSSI value extracted from the RFM96 chip is converted to dBm using the formula:

 [] = −137 + ℎ

(29)

and the SNR calculated using:



[]

=

ℎ 4

(30)

as defined in the RFM96 data sheet [28]. 35

The sample mean ̅ of the RSSI and SNR was calculated using: 1 
̅ =  ∑ 
=1
and the sample standard deviation  calculated using:



=

1  √ − 1 ∑(

−

̅)2

=1

(31) (32)

6.4 Validating functions for determining RSSI and SNR
This implementation chapter will now be concluded by presenting an excerpt of the code that calculates the RSSI and SNR values, and the test that was done to validate the codes functionality.
The RFM96 chip calculates SNR and RSSI during the demodulation of a received packet, and stores the result as 8 bit values in its own internal memory. Those values are then read into the STM32L1 microcontroller via SPI, and processed as described earlier.
6.4.1 Code snippets The read RSSI and SNR values are stored as 16 bit integers in respective arrays in the MCU, and the deviation and mean values in 64-bit precision float variables.
Listing 1, variable declaration in receiver firmware
1. int16_t rssi_list[MAX_EXPECTED_NUM_PACKAGES]; 2. int16_t snr_list[MAX_EXPECTED_NUM_PACKAGES]; 3. double rssi_mean; 4. double rssi_std; 5. double snr_mean; 6. double snr_std;
To calculate the RSSI dBm and SNR dB values, the following code is used after a packet has been successfully received:
Listing 2, recording RSSI and SNR values to respective arrays
1. rssi_list[num_pkts-1] = -137 + rfm96_read_reg(REG_PKT_RSSI_VALUE); 2. snr_list[num_pkts-1] = (int16_t)(rfm96_read_reg(REG_PKT_SNR_VALUE) * 0.25);
The rfm96_read_reg function reads a value from one of the memory registers in the RFM96 chips over SPI. Here, the registers containing the RSSI and SNR values are read, and then converted and stored in arrays. The num_pkts variable tracks the number of received packets, and is used for array indexing.
When the expected number of packets has been received, the rssi_list and std_list contents are used to calculate the mean and deviation.
36

Listing 3 show the implementation that were used for calculating mean, variance and standard deviation.

Listing 3, statistical functions used in receiver code

1. /* Calculates sample mean */

2. double mean(int16_t a[], uint16_t n)

3. {

4.

double sum = 0.0;

5.

for (int i = 0; i < n; i++)

6.

{

7.

sum += (double) a[i] / (double) n;

8.

}

9.

return sum;

10. }

11.

12. /* Calculates sample variance */

13. double variance(int16_t a[], uint16_t n, double mean)

14. {

15. double sum = 0.0;

16. double diff = 0.0;

17. for (int i = 0; i < n; i++)

18. {

19.

diff = (double) a[i] - mean;

20.

sum += (diff * diff);

21. }

22. sum /= (double)(n - 1);

23. return sum;

24. }

25.

26. /* Calculates sample standard deviation */

27. double std_dev(int16_t a[], uint16_t n, double mean)

28. {

29. return sqrt(variance(a, n, mean));

30. }

6.4.2 Validation of statistical functions
In order to validate that the statistical functions were correctly implemented, their output were compared to output of the math software Mathematica for a given test array.

The code in Listing 3 was copied to a test.c file with a main-function and compiled as a desktop application. The array that was fed, and the Mathematica output, can be seen at the top of Figure 16, and the output of the test program can be seen in Figure 17.

37

Figure 16, Mathematica output for the test input
Figure 17, output of test program for statistical functions for the test input
The result of the test show that the implementation gives an expected value, and is reliable during testing. The expected values of the RSSI and SNR values are in the range of -150 to +150, so the variable sizes of 16-bit integers and 64-bit floats are well within capacity to store all values without risk of overflow or precision errors.
38

7 Simulations and Field Tests
This chapter describes the simulation and field test that was made for determining the performance of the LoRa transceiver. First, the simulation done using the software Radio Mobile is introduced. Then, the method of measuring between bridges in Stockholm is presented together with the considered and then visited measurement sites.
The purposes of the measurements were to determine the characteristics of the received signal strength, signal-to-noise ratio and packet delivery ratio of the system, so that a model of the system performance could be constructed from the data. However, the RSSI measurements from the chip did not come out as expected, and so a characterization of the RSSI meter was done and will be discussed.

7.1 Simulating performance of radio links using Radio Mobile
To examine the performance of the system in the SK0MT–Vaxholm scenario using the LoRa transceiver with settings as discussed earlier in this report, a simulation was done using the Radio Mobile software.

Radio Mobile is a network planning tool that uses the Irregular Terrain Model propagation model to simulate coverage and point-to-point transmissions. The simulations calculate the effect of obstacles in the propagation path based on terrain elevation data feed into the software, and gives an estimation of the received signal strength.

The software was supplied to the project bundled together with terrain data of the greater Stockholm area that had been used in a radio network planning course.

7.1.1 Simulation settings and sites
The network nodes were configured to send with 10 dBm, no cable loss and no gain, omnidirectional directivity and have a sensitivity of -151 dBm. The SK0MT node was configured to use an antenna height of 40 m from ground, the Ullna landfill node to use 2 m from ground.

For the Rindö and Vaxholm sites, it was assumed that the antennas would be placed on the roof of the Redoubt and Fortress respectively, so the antenna heights were set to 10 m from ground as an approximation of mast and roof height.

Table 3, simulation site coordinates

Site

Latitude

SK0MT

59.45026

Ullna landfill

59.47148

Rindö Redoubt

59.40612

Vaxholm Fortress

59.40322

Longitude 18.08007 18.14277 18.36694 18.35913
39

The sites coordinates were determined using Google maps, and were confirmed by comparing the height of the sites in the simulation to the elevation given by topographic-map.com [10] (see Table 3).
Figure 18, map of sites in Radio Mobile simulation software
By comparing the resulting site map in Figure 18 with the map of the sites from introduction (Figure 2), it is clear that site positions are the same.
7.2 Measuring radio LoS-performance using local bridges
In order to validate the implemented system, a field test was done where performance was measured in line-of-sight conditions. Bridges in central Stockholm were used to find measurement sites with kilometre-distance line-ofsight. By measuring RSSI, SNR and PDR at various distances, data was to be collected to model the system performance. Using bridges was seen as a simple way to find elevated sites with obstruction free line-of sight to each other. 7.2.1 Considered measurement sites Stockholm city consists of lots of open water, and with several bridges connecting the Södermalm district-island to the rest of the city. Therefore, these bridges were considered for measurement sites. Google maps 3D satellite view was used to get a sense of the line-of-sight condition between bridges, and to plan out which bridges to measure between. In order to get measurement sites with greater kilometre separation, some measurement sites were placed between three bridges instead of two.
40

The expectation was that transmissions should be able to manage the additional losses introduced by the intermediate bridge without a large signal loss. The considered sites are summarized in Table 4 and depicted in Figure 19.

Figure 19, map of considered measurement sites

Table 4, suggested measurement sites

Site 1

Site 2

Liljeholmsbron

Årstabron

Essingebron

Västerbron

Skanstullsbron

Årstabron

Essingebron

Årstabron

Järnvägsbron

Essingebron

Distance (km) 0.75 1.8 2.3 3.0 3.7

7.2.2 Used measurement sites
During the actual measurement campaign, the system performed under expectations. The first measurement was done between Järnvägsbron and Essingebron, but no packets were received despite optical line-of-sight between the sites.

Therefore, a shorter distance was attempted between Essingebron and Västerbron. Here, packets were received as expected and data could be collected. Instead of continuing the measurements at the considered sites, they were done at various locations near Västerbron and Järnvägsbron to better determine the performance at shorter distances.

After the measurements at Västerbron and Järnvägsbron were done, a final measurement was done between Liljeholmsbron and Årstabron. The visited sites are summarized in Table 5 and depicted in Figure 20.

7.3 Characterizing the RFM96 RSSI meter
The RSSI data that was collected during the measurement campaign exhibited a strange trend, where it would appear “stuck” at the same dBm value at varying
41

distances. Therefore, careful measurements were done in the interval of 1 to 500 m to characterize the sensitivity of the RSSI meter.
These measurements were performed in an open field with transmitter and receiver held by the operators at a height of 1.5 – 2 m, with 10 measurements per decade.
An additional experiment was done indoors where the transmitter and receiver were separated by several walls. At the last point where the packets were still being received, the RSSI value was the same as for the outdoor measurements.
Using the debugger of the development software for the STM32 microcontroller, the raw RSSI values read from the chip were inspected. These also exhibited the behaviour of flattening out at a certain distance.
The measurements were made in an office building with several walls between transmitter and receiver, at the point where just about stopped receiving packets, and measured both with and without antenna on the receiver.

Figure 20, map of visited sites for measurements

Table 5, Visited measurement site distances

Transmitter site

Receiver site

Liljeholmsbron

Årstabron

Västerbron site 1

Preem gas station

Västerbron site 1

Town hall

Västerbron site 1

Essingebron

Västerbron site 2

Järnvägsbron

Västerbron site 2

Birger Jarls torg

Västerbron site 2

Vasabron

Essingebron

Järnvägsbron

Distance (km) 0.75 0.91 1.5 1.75 1.9 1.9 2.0 3.7

42

8 Result
This chapter will present the result of the radio link simulation and the signal strength measurements. First, the result of the radio link simulation in Radio Mobile for the SK0MT–Vaxholm scenario as a series of print screens from the software. Then, the result from the measurements done with the experimentprototypes between the bridges in Stockholm is presented, followed by the characterisation attempt that was made for the RSSI meter on the RFM96 radio chip.
8.1 Simulation results
Figure 21, simulation result of SK0MT–Ullna landfill radio link
Figure 21, Figure 22 and Figure 23 show the result of the simulation. The transmitter is to the left and receiver to the right, with brown shapes representing ground terrain, and the grey shapes the tree-lines At the bottom of the figures, the antenna height measured from ground level, transmitter power, receiver sensitivity, antenna gains, and cable losses can be seen. At the top of the figures, the free space path loss, actual path loss, received signal level and distance can be seen. The first, second and third Fresnel zones are drawn using white lines and the line-of-sight as the dotted green line. Relevant data from the figures have been summarized in Table 6, where Tx height and Rx height are the antenna heights of the transmitter and received respectively, measured from ground level.
43

Figure 22, simulation result of Ullna–Rindö radio link
Figure 23, simulation result of Rindö–Vaxholm radio link
44

Table 6, Summary of relevant simulation data

Tx site Rx site Distance Tx height

SK0MT Ullna

4.22 km 40 m

Ullna

Rindö 14.64 km 2 m

Rindö Vaxholm 0.55 km 10 m

Rx height 2m 10 m 10 m

Path loss 100.4 dB 129.8 dB 87.9 dB

Rx Level -90.4 dBm -119.8 dBm -77.9 dBm

8.2 Bridge measurements
The measurements that were done with transmitter standing on a bridge used 1000 packets per site for calculating the mean values ̅̅̅̅̅̅̅ and ̅̅̅̅̅̅, as well as RSSI sample standard deviation . Due to a programming error, the SNR standard deviation was calculated using the mean for the RSSI and therefor discarded.

Table 7, Bridge measurement data

Tx site

Rx site

Liljeholmsbron Årstabron

Västerbron site 1 Preem gas station

Västerbron site 1 Town hall

Västerbron site 1 Essingebron

Västerbron site 2 Järnvägsbron

Västerbron site 2 Birger Jarls torg

Västerbron site 2 Vasabron

Essingebron

Järnvägsbron

Distance 0.75 km 0.91 km 1.5 km
1.75 km 1.9 km 1.9 km 2.0 km 3.7 km

PDR 92 % 96 % 0%
95 % 97 % 99 % 85 % 0%

̅̅̅̅̅̅̅ -65.44 dBm -65.62 dBm – -65.97 dBm -66.25 dBm -65.4 dBm -65.3 dBm –

 0.8 0.6 – 0.5 1.2 0.5 0.5 –

̅̅̅̅̅̅ 50.78 49.97 – 50.6 50.3 54.9 54.9 –

The measurement done with the receiver at Stockholm town hall was obstructed by trees and sailing boats, and the measurement between Essingebron and Järnvägsbron was obstructed by the island Lilla Essingen and Västerbron.

Figure 24, log-log plot of RSSI mean values from bridge measurements
Figure 24 shows a log-log plot of the RSSI mean values collected during the bridge measurements with a clear tendency around -65 dBm.
45

Photos were taken from the point of view of the transmitter and receiver for the sites where communication failed, Figures Figure 25, Figure 26, Figure 27 and Figure 28. Potentially obstructing residential buildings on Lilla Essingen can be seen on the left part of Figure 25.
Figure 25, transmitter point of view between Essingebron and Järnvägsbron
Figure 26, transmitter point of view zoomed in. Järnvägsbron circled.
46

Figure 27, receiver point of view between Essingebron and Järnvägsbron
Figure 28, receiver point of view zoomed in. Essingebron circled.
47

8.3 Ground measurements
Table 8 and Figure 29 shows the RSSI values gathered during ground level measurements when attempting a characterization of the RSSI meter.

Figure 29, log-log plot of RSSI mean values from bridge measurements

Table 8, RSSI characterization measurement

Distance (m)

PDR

̅̅̅̅̅̅̅ (dBm)

1

100 %

-34.44

2

99 %

-36.40

3

100 %

-39.94

4

100 %

-43.54

5

99 %

-43.43

6

99 %

-45.92

7

99 %

-46.48

8

99 %

-48.18

9

100 %

-48.55

10

99 %

-49.19

20

100 %

-49.66

30

100 %

-51.49

40

100 %

-57.90

50

99 %

-60.84

60

99 %

-62.63

70

100 %

-61.68

80

100 %

-64.25

90

99 %

-64.97

100

99 %

-64.90

200

97 %

-65.64

300

99 %

-65.22

400

81 %

-65.35

500

0%

–

 0.5 1.4 2.2 1.5 1.3 2.3 2.6 2.0 1.7 2.2 1.6 1.5 1.3 1.6 1.0 1.2 0.8 0.7 0.5 1.0 0.4
0.9 –

̅̅̅̅̅̅ 10.80 10.97 10.34 10.62 10.16 10.21 11.13 10.10 10.35 10.52 10.32 10.29 7.2 4.8 4.7 7.1 47.18 57.39 58.29 52.45 – 48.79 –
48

8.4 RSSI characteristics
This section presents screen dumps from the software debugging tool “Live Watch” displaying raw RSSI values read from the chip at the point where they became unchanged with increased distance, and a plot of the combined ground and bridge measurement values depicting the receiver RSSI-sensitivity characteristics. 8.4.1 Data read from RSSI chip
Figure 30, RSSI in STM32 software in dBm (left) and raw (right) format with antenna attached to receiver
In Figure 30, RSSI in STM32 software in dBm (left) and raw (right) format with antenna attached to receiverFigure 30, the Live Watch window is displayed with four columns. The first column names the variable that is inspected (the arrays rssi_list and rssi_raw), the second column the values of each element in the inspected arrays, the third column shows the variables location in the microcontroller’s memory, and the final column the data type of each element. rssi_raw in Figure 30 contains RSSI-values read directly from the LoRa transceiver chip, and is converted into their actual dBm values in rssi_list.
49

Figure 31, mean and deviation as calculated in the STM32 software Figure 32, mean and deviation as calculated in the STM32 software
with antenna unattached to receiver
Figure 33, RSSI in STM32 software in dBm (left) and raw (right) format with antenna unattached to receiver
50

8.4.2 RSSI characteristic curve with antenna equipped receiver
Figure 34, measured RSSI data (blue squares) compared to the expected path loss (orange triangles)
The combined RSSI values are compared in Figure 34 to the free space path loss adjusted with a constant to coincide with the second data point. For each decade of distance, there is a noticeably increasing deviation from the expected values.
51

9 Discussion
This concluding chapter will discuss the result of the simulation and measurement campaign, and what could’ve affected the measurements giving unexpected values. The chosen measurement method will also be discussed, and alternative methods proposed. Finally, topics for future research related to the electric switch system will be presented.
9.1 Interpreting results
This section will discuss the results obtained from the simulation and measurement campaign, as well as the attempt that was made at characterising the RSSI meter on the RFM96 LoRa radio chip.
9.1.1 Radio Mobile simulation of radio links The received signal strength calculated by the simulation software (Table 6) for the Ullna landfill, Rindö Redoubt and Vaxholm Fortress show that all three sites have a lot of fade margin and therefore should be reliable radio links.
Although the received signal strength is strong, the impact of fading and ISMband interference on bit errors in the packet were not considered in the simulation. Therefore, it is possible that the packet delivery ratio would be low, and that several packets would have to be burst transmitted when communicating.
Figure 22 shows that the terrain data used in the simulation between the Ullna landfill and Rindö Redoubt had a 60 m high hill near Ullna after about 2 km. When this was compared with Google maps and topographic-map.com, no hill of that height was found. It is therefore uncertain if the terrain data used is in the simulation is accurate.
The unexpected hill in the simulation, however, did not block the signal from reaching Rindö Redoubt, only accounting for 11.5 dB obstruction.
9.1.2 Packet delivery ratios when measuring between bridges Measurements done between bridges in Stockholm show that the packet delivery ratio can be above 95% at distances of 1 to 2 km, when the amount off obstruction is low (Table 7).
Three measurements were made in close proximity to each other with about 2 km distance to the transmitter, only differing in the amount of obstruction and the height of the receiver.
Västerbron to Järnvägsbron showed a 97% PDR and Västerbron to Birger Jarls torg a 99% PDR. Birger Jarls torg is elevated a couple of meters higher than Järnväsgbron, which means the result is expected since higher receiver elevation means less ground reflections and less obstacles in the Fresnel zone.
52

Västerbron to Vasabron showed an 85% PDR, which can be explained by more obstruction being introduced in the propagation path. This would indicate that the packet delivery ratio is very dependent on the amount of obstruction, which is expected.
No packets were received between Essingebron and Järnvägsbron, even though Figure 25 and Figure 27 show that there is an optical line of sight between the transmitter and receiver.
This could be explained by buildings on the island Lilla Essingen and Västerbron (to the left in Figure 25) causing bit errors due to too much interference from signal reflection, combined with propagation loss from the distance.
Since forward error correction was used on the LoRa transceiver, packets that contained too many errors were discarded. It is therefore possible that packets could’ve been received, but that their contents would’ve been scrambled.
9.1.3 Incorrect RSSI and SNR The measurements that were done of received signal strength indication and signal-to-noise ratio at the various sites were unexpected and incorrect.
The SNR readings did not tend towards a lower value as distance increased, but instead jumped to around 50 dBm after 100 m. Due to a programming error, the sample variation of the SNR could not be correctly determined.
The RSSI values seemed reasonable only at a distance between 1 to 100 m, and after that the readings tended towards –65 dBm no matter the distance between the radio units. As is seen in Figure 34, the RSSI characteristic curve flattens out.
This could be explained by the RSSI meter having a poor sensitivity for low signal levels, but as can be seen in Figure 33, it reacts to the antenna being unscrewed from the receiver. With no antenna, a lower RSSI value could be read from the chip than with the antenna, but later flattened out as well. The reason for this phenomenon was not found.
9.1.4 Microcontroller RSSI readings and processing Figure 30 and Figure 33 shows the raw RSSI values read from the RFM96 chip into the STM32L1 over SPI. The right halves of the figures shows the list of raw RSSI values, and the left halves the corresponding dBm values.
The measurements were made by finding the distance in an office building where the receiver just about stopped receiving packets, which means the readings are the lowest that the RSSI meter will give.
The calculated statistical data are shown in Figure 31 and Figure 32 shows that the mean and sample deviation are correctly calculated, as has been shown earlier in section 6.4.2.
53

It is therefore unlikely that the erroneous RSSI readings are the fault of the microcontroller software, and rather is a combination of some unknown factors one of which is the RFM96 chips RSSI meter.
9.2 Other suitable measurement methods
The method of measuring line-of-sight performance between bridges was good in theory, but practically severely limited the distances where measurements could be made. Additionally, in practice some of the desired measurement sites did not give any measurement data (Essingebron to Järnvägsbron) which restricted the number of data points further.
As an alternative, to give more flexibility in determining the distance between each measurement sight with less or no obstruction would be to use a boat or an airborne vehicle such as a drone or balloon.
Even if the issue of RSSI and SNR values being incorrectly given from the radio chip would persist, this alternative method would allow packet delivery ratio data to be collected for varying distances and later modelled.’
9.3 Evaluation of chosen research methodology
The problem statement for the report was “What is a suitable radio link technology for use in a remote controlled electrical switch system and how should it best be put to use?”
To answer the question, a LPWAN link technology was to be chosen and evaluated with an implemented prototype using the Design Science Research methodology.
The choice to use LoRa was well founded based on the studies presented in the related studies section (4.6), as their findings together with the theoretical examination that was done in section 5.4 suggested that LoRa should have the capabilities demanded by the problem scenario of the SK0MT–Vaxholm links.
Using bridges to measure signal strengths had the considerable drawback of limiting the variation of distance between the sending radio and the receiving radio, as was discussed in the previous section.
In this study, no reference data was produced prior to performing the field testing. Therefor, there were no concrete expected measurement values that were cross referenced during experimentation.
A better method for evaluating the chosen radio link technology would have been to try to recreate the result from one of the studies in the related studies, as this would have given a concrete reference point for the data that the measurements would produce.
54

Because the study lacks conclusive research results, guideline 4 in the designscience methodology paper presented on page 9 has not been meet. It is therefore debatable to what extent the findings in this report are innovative.
9.4 Future work
The purpose of this report was to lay the ground work for an implementation of the proposed electric switch system to solve the problem AMPRnet Sweden had with their power driven outdoor network bridge radio nodes discharging batteries when left in standby mode.
Future work that could be done in this problem area is redo the radio performance measurements with a better method, examine the security aspects of the design (threats and mechanisms for combatting them), examine ways to save power in the design and implementing the full system with a user interface.
The issue with the RSSI and SNR values being incorrectly measured could be solved, so that the measuring experiment can be redone, and the LoRa transceivers performance properly determined. Such an experiment should also have proper expected values prepared beforehand, so that the measured values can be compared to something.
One security mechanism that could be explored is the use of a Rolling Code protocol [31] to protect against a man-in-the-middle attack where an eaves dropper learns what commands to send to a node. Frequency hopping could also be used as a security mechanism, which would protect against jamming and eaves- dropping.
The STM32L1 features power saving techniques such as sleep modes, where the microcontroller switches of peripherals and lowers CPU, memory and I/O functionality. These could be explored to make the receiver draw less power when waiting for a packet to arrive.
9.5 Conclusion
The goal of this project was to find a design for a proof-of-concept of the remotecontrolled electric switch system, and then implement and test that system. A simple design was made with one transmitter and one receiver, and parameters for the LoRa transceiver derived.
The problem statement “What is a suitable radio link technology for use in a remote controlled electrical switch system and how should it best be put to use?” was answered with a candidate, LoRa physical. Theoretical support was found for the candidate using calculations and simulations, but the attempt to validate the claim with field measurements on an implementation with a single transmitter and receiver failed to give conclusive results.
55

A simulation of the system was made in the problem scenario, which indicated that the radio links would be strong. However, the reliability of the packet delivery ratio due to bit errors was not explored in the simulation. The LoRa settings were then tested with the transmitter and receiver units, but gave inconclusive results. Therefore, no definitive validation of the system was made for the desired 15 km range, but the LoRa radio link was proven functional for a LoS distance of at least 2 km. The inconclusive measurements was determined to be due to the LoRa transceiver chip giving incorrect values to the systems microcontroller after a distance of 100 m. The reason for this phenomenon was not determined, but a fault in the transceiver chip was suspected. The broadcasting condition for the network bridge problem scenario is similar to those explored in the related studies in section 4.6Error! Reference source not found., particularly the Antarctic study by Gaelens et al. Therefor there exists prior empirical experience with the LoRa transceiver that suggest that the circuit-breaker system should manage the 15 km distance between Ullna and Rindö. As the design science research methodology requires a proposed design to be implemented and thoroughly tested, the work done in this report could be considered unfinished. While the problems with the RSSI readings were explored, the problem was not solved, and so the measurement campaign could not be concluded. The goal of designing, implementing and testing the proof-of-concept system has only been partially met. The ground work for the design has been made, and there are indications that the full system will be able to solve the problem of controlling the power of AMPRnet network bridge nodes remotely. Finishing this work has been left for future studies.
56

References

[1] “Design science in information systems research,” MIS Q., vol. 28, no. 1, pp.

75–105, Mar. 2004.

[2] J. Gaelens, P. Van Torre, J. Verhaevert, and H. Rogier, “LoRa Mobile-To-Base-

Station Channel Characterization in the Antarctic,” Sensors, vol. 17, no. 8,

Aug. 2017.

[3] J. Petäjäjärvi, K. Mikhaylov, A. Roivainen, T. Hänninen, and M. Pettissalo, “On

the Coverage of LPWANs: Range Evaluation and Channel Attenuation Model

for LoRa Technology,” International Conference on ITS Telecommunications,

2015.

[4] R. Sanchez-Iborra, J. Sanchez-Gomez, J. Ballesta-Viñas, M.-D. Cano, and A. F.

Skarmeta, “Performance Evaluation of LoRa Considering Scenario

Conditions,” Sensors, vol. 18, no. 3, p. 772, Mar. 2018.

[5] “Msb.se - Om samhällsviktig verksamhet.” [Online]. Available:

https://www.msb.se/sv/Forebyggande/Krisberedskap/Samhallsviktig-

verksamhet/Om-samhallsviktig-verksamhet/. [Accessed: 17-Apr-2018].

[6] C. Hedlund, “Utbildnings- och övningsstrategi för krisberedskap 2017-2021,”

Post- och Telestyrelsen, Stockholm, PTS-ER-2017:02, Jan. 2017.

[7] “FRO – The Voluntary Radio Organisation,” Frivilliga Radioorganisationen,

12-Aug-2018. [Online]. Available: https://fro.se/in-english. [Accessed: 24-

May-2018].

[8] “Amateur Radio Digital Communications | Managing the AMPRNetTM —

TCP/IP Networking for Amateur Radio.” .

[9] AMPRnet Sverige, “AMPRnet Broschyr.”

[10] “Topographic map Stockholm,” topographic-map.com. [Online]. Available:

http://en-us.topographic-map.com/places/Stockholm-8017339/. [Accessed:

24-May-2018].

[11] “Ubiquiti Networks - NanoBridge® M.” [Online]. Available:

https://www.ubnt.com/airmax/nanobridgem/. [Accessed: 24-May-2018].

[12] B. Pehrson, “sk0mt-amprnet-node,” 26-Feb-2018. [Online]. Available:

http://amprnet.se/kraft/sk0mt-amprnet-node.pdf. [Accessed: 24-May-

2018].

[13] U. Raza, P. Kulkarni, and M. Sooriyabandara, “Low Power Wide Area

Networks: An Overview,” IEEE Commun. Surv. Tutor., vol. 19, no. 2, pp. 855–

873, Secondquarter 2017.

[14] “RPMA technology: for the internet of things,” Ingenu Ramp.

[15] “Semtech LoRa Technology Overview | Semtech.” [Online]. Available:

https://www.semtech.com/lora. [Accessed: 19-Aug-2018].

[16] M. Bor and U. Roedig, “LoRa Transmission Parameter Selection,” in 2017

13th International Conference on Distributed Computing in Sensor Systems

(DCOSS), 2017, pp. 27–34.

[17] “Sigfox

Product

Page.”

[Online].

Available:

https://partners.sigfox.com/search/products. [Accessed: 12-Aug-2018].

[18] G. Ferré and E. P. Simon, “An introduction to Sigfox and LoRa PHY and

MAC layers,” Apr-2018.

57

[19] “Sigfox Technical Overview,” Sigfox, Jul. 2017.

[20] “Telensa joins TALQ Consortium to support interoperability of… |

Telensa.” [Online]. Available: https://www.telensa.com/news/telensa-joins-

talq-consortium-to-support-interoperability-of-street-lighting-networks.

[Accessed: 12-Aug-2018].

[21] W. Stallings and C. Beard, Wireless Communications & Networks, 1th ed.

Pearson, 2015.

[22] M. Hata, “Empirical formula for propagation loss in land mobile radio

services,” IEEE Trans. Veh. Technol., vol. 29, no. 3, pp. 317–325, Aug. 1980.

[23] D. Coleman and D. Westcott, Certified Wireless Network Administrator

Official Study Guide, 3rd ed. Sybex, 2012.

[24] “kommissionens genomförandebeslut av den 11 december 2013 om

ändring av beslut 2006/771/EG om harmonisering av radiospektrum för

användning av kortdistansutrustning och om upphävande av beslut

2005/928/EG.” Europeiska unionens officiella tidning, 11-Dec-2013.

[25] “LoRaTM Modulation Basics,” Semtech, Application Note AN1200.22, May

2015.

[26] “LoRa Modem Design Guide,” Semtech Corporation, Application Note

SX1272/3/6/7/8, Jul. 2013.

[27] “STM32L1 - ARM Cortex-M3 ultra-low-power MCUs -

STMicroelectronics.”

[Online].

Available:

http://www.st.com/en/microcontrollers/stm32l1-

series.html?querycriteria=productId=SS1295. [Accessed: 28-May-2018].

[28] “RFM95/96/97/98 Data Sheet,” HOPE RF Electronic, Data Sheet.

[29] “RG178 Coax Cable Data Sheet,” Pro-Power, Data Sheet, Nov. 2011.

[30] S. Mistry, “arduino-LoRa: An Arduino library for sending and receiving

data using LoRa radios,” GitHub, 25-May-2018. [Online]. Available:

https://github.com/sandeepmistry/arduino-LoRa. [Accessed: 28-May-2018].

[31] “AVR411: Secure Rolling Code Algorithm for Wireless Link,” Atmel,

Application Note 2600E-AVR, 07/15.

58

TRITA TRITA-EECS-EX-2019:30
www.kth.se

