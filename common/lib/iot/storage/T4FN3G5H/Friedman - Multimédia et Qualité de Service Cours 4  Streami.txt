√† l‚ÄôUniversit√© Pierre et Marie Curie, le 19 octobre 2004
M2 Informatique R√©seaux
Multim√©dia et Qualit√© de Service
Cours 4 : Streaming et Signalisation
Timur FRIEDMAN
transparents adapt√©s de &RPSXWHU 1HWZRUNLQJ copyright 1996-2002 J.F. Kurose et K.W. Ross une partie des traductions gr√¢ce √† Kav√© SALAMATIAN
1

Plan
I Applications multim√©dia I Streaming d‚Äôaudio et
vid√©o stock√©s
I RTSP
I Exemple de l‚Äôinteractive: t√©l√©phonie sur IP
I Applications en tempsr√©el
I SIP
2

Applications multim√©dia
I Les classes d‚Äôapplications
I VWUHDPLQJ d‚Äôaudio et vid√©o stock√©s I VWUHDPLQJ d‚Äôaudio et vid√©o en direct I audio et vid√©o interactives en temps r√©el
I VWUHDPLQJ = la lecture en transit
I Les caract√©ristiques
I sensible aux d√©lais
I de bout en bout I la gigue
I r√©sistant aux pertes
3

Streaming d‚Äôaudio et vid√©o stock√©s
I media est stock√© √† la source I transmis au client I streaming : le client commence la
lecture DYDQW la fin de la r√©ception
I contrainte temporelle pour les donn√©es qui restent √† transmettre :
I qu‚Äôelles arrivent √† temps pour la lecture
4

Le streaming

Quantit√© de donn√©es

1. vid√©o enregistr√©e

2. vid√©o envoy√©e

GpODL UpVHDX

3. vid√©o re√ßue, lecture par le client
temps

VWUHDPLQJ A cet instant, le client commence √† afficher la vid√©o alors
que le serveur continue de transmettre
le reste de la vid√©o

5

L‚Äôint√©ractivit√© et les donn√©es stock√©es
I )RQFWLRQQDOLWp PDJQpWRVFRSH  le client peut arr√™ter, rembobiner, avancer I d√©lai initial de 10 sec OK I 1-2 sec avant l‚Äô√©xecution de la commande OK
6

Streaming d‚Äôaudio et vid√©o en direct
Exemples I radio par Internet I transmission des matches sportives Streaming I m√©moire tampon pour la lecture I la lecture peut s‚Äôeffectuer plusieurs dizaines de
secondes apr√®s la transmission I il y a toujours des contraintes temporelles Interactivit√© I avancer impossible I rembobiner, pause possible
7

Audio et vid√©o interactives en temps r√©el
I applications : t√©l√©phonie sur IP, visioconf√©rence, jeux interactifs, mondes virtuels
I d√©lai de bout en bout requis :
I audio : < 150 ms bon, < 400 ms OK I vid√©o : < 150 ms
I Le d√©lai inclue le traitement par l‚Äôapplication :
I mise en paquets I compression
8

Plan
I Applications multim√©dia I Streaming d‚Äôaudio et
vid√©o stock√©s
I RTSP
I Exemple de l‚Äôinteractive: t√©l√©phonie sur IP
I Applications en tempsr√©el
I SIP
9

Streaming d‚Äôaudio et vid√©o stock√©s

Techniques de streaming au niveau applicatif pour faire face √† un Internet moindre effort :
I mise en m√©moire tampon du c√¥t√© client
I UDP et TCP mixtes
I plusieurs encodages possible pour le multim√©dia

Lect eur M√©dia
I suppression de la gigue I d√©compression I dissimulation d‚Äôerreurs I interface graphique
avec contr√¥les pour l‚Äôinteractivit√©

10

L‚Äôapproche la plus simple
I audio et vid√©o enregistr√© dans des fichiers I les fichiers sont transmis en tant qu‚Äôobjets
HTTP I d‚Äôabord re√ßus compl√®tement chez le client I transfert au lecteur apr√®s
audio et vid√©o ne sont pas lise en transit : I pas de pipeline, d√©lai de r√©ception important
avant l‚Äôaffichage
11

Une approche streaming
I le navigateur re√ßoit un PHWDILFKLHU par GET I le navigateur ex√©cute le lecteur ¬´ plug-in ¬ª et lui passe le
metafichier I le lecteur contacte le serveur I le serveur envois le flot audio/vid√©o au lecteur en streaming
12

Une approche avec un serveur streaming
I Cet architecture permet l‚Äôutilisation d‚Äôun protocole non-HTTP entre le serveur le lecteur multim√©dia.
I Permet l‚Äôutilisation de UDP au lieu de TCP.
13

Mise en m√©moire tampon du client

Quantit√© de donn√©es
vid√©o en m√©moire

vid√©o CBR
GpODL YDULDEOH GX UpVHDX

r√©ception au client

lecture CBR du vid√©o au client

d√©lai au client avant lecture

temps

I Compensation pour le d√©lai du r√©seau, la gigue :
I mise en m√©moire I d√©lai avant la lecture au client
14

D√©tails de la m√©moire

taux variable x(t)

taux constant
d

vid√©o en m√©moire
I La m√©moire tampon compense la gigue du d√©lai
15

Streaming du multim√©dia par UDP
I Le serveur √©met avec un d√©bit ad√©quat pour le client
I sp√©cialement s‚Äôil ignore les probl√®mes de congestion I d√©bit √©metteur = taux d‚Äôencodage (CBR) I d√©bit r√©cepteur = CBR ‚Äì pertes de paquets
I D√©lais de d√©marrage courts (2-5 seconds) pour compenser la gigue du d√©lai
I Compensation de pertes : si la contrainte temporelle le permet
16

Streaming du multim√©dia par TCP
I Le serveur √©met au d√©bit maximal permis par TCP
I Le d√©bit r√©cepteur varie √† cause du contr√¥le de congestion TCP
I Plus qu‚Äôon ajoute du d√©lai au client, plus la lecture du vid√©o devient lisse
I HTTP/TCP passent plus facilement √† travers les parefeux
17

Clients h√©t√©rog√®nes
encodage √† 1.5 Mb/s encodage √† 28.8 Kb/s

Q : Comment g√©rer plusieurs clients avec des d√©bits de r√©ception h√©t√©rog√®nes ?

I 28.8 Kb/s connexion par modem

I 100Mb/s sur Ethernet

R : Le serveur garde et transmet de multiples

copies de la vid√©o encod√©, avec des d√©bits

diff√©rents

18

RTSP ¬´ Real Time Streaming Protocol ¬ª

HTTP

Limites de RTSP :

I Pas cibl√© vers le multim√©dia I pas de d√©finition du

I Pas de commandes pour

codage audio/vid√©o

avancer, rembobiner, etc. I pas de d√©finition de la

couche transport : le media

RTSP : RFC 2326
I Protocole client-serveur au niveau applicatif.
I Fonctionnalit√©s fournies au client: avancer, rembobiner, pause, repositionnement,

peut √™tre transport√© par UDP ou par TCP
I pas de d√©finition de la mani√®re dont le client doit faire la mise en m√©moire tampon d‚Äôaudio ou vid√©o

etc.‚Ä¶

19

RTSP: un contr√¥le hors bande

Comme avec FTP :
I Dans FTP, un fichier est transmis sur une connexion TCP.
I La signalisation de contr√¥le (changement de r√©pertoire, effacement de fichier, renomm√©ment de fichier, etc.) est transmise sur une connexion TCP ind√©pendante.
I Les canaux hors-bande et intrabande utilisent des num√©ros de ports diff√©rents.

RTSP :
I Le flux multim√©dia est l‚Äôintrabande
I Les messages de contr√¥le RTSP utilisent un num√©ro de port hors-bande r√©serv√©.
I Port 554

20

RTSP : un exemple
Sc√©nario:
I un metafichier est transmis au navigateur I le navigateur ex√©cute le lecteur I le lecteur construit :
I une connexion de contr√¥le RTSP I une connexion pour les donn√©es multim√©dia
21

Metafichier : exemple
<title>Twister</title> <session>
<group language=en lipsync> <switch> <track type=audio e="PCMU/8000/1" src = "rtsp://audio.example.com/twister/audio.en/lofi"> <track type=audio e="DVI4/16000/2" pt="90 DVI4/8000/1" src="rtsp://audio.example.com/twister/audio.en/hifi"> </switch>
<track type="video/jpeg" src="rtsp://video.example.com/twister/video">
</group> </session>
22

Fonctionnement du RTSP
23

RTSP : exemple d‚Äôun √©change client-serveur
C: SETUP rtsp://audio.example.com/twister/audio RTSP/1.0 Transport: rtp/udp; compression; port=3056; mode=PLAY
S: RTSP/1.0 200 1 OK Session 4231
C: PLAY rtsp://audio.example.com/twister/audio.en/lofi RTSP/1.0 Session: 4231 Range: npt=0-
C: PAUSE rtsp://audio.example.com/twister/audio.en/lofi RTSP/1.0 Session: 4231 Range: npt=37
C: TEARDOWN rtsp://audio.example.com/twister/audio.en/lofi RTSP/1.0 Session: 4231
S: 200 3 OK
24

Plan
I Applications multim√©dia I Streaming d‚Äôaudio et
vid√©o stock√©s
I RTSP
I Exemple de l‚Äôinteractive: t√©l√©phonie sur IP
I Applications en tempsr√©el
I SIP
25

Applications interactives en temps r√©el

I t√©l√©phonie PC √† PC
I fourni par les services de messagerie instantan√©e
I PC √† t√©l√©phone
I Dialpad
I Net2phone
I visioconf√©rence avec Webcam

Examinons l‚Äôexemple de t√©l√©phonie PC √† PC
26

Multim√©dia interactif : t√©l√©phonie sur IP
Notre exemple : I La voix alterne des p√©riodes de son et de silence.
I 64 kb/s pendant une p√©riode de son
I Des paquets ne sont g√©n√©r√©s que durant des p√©riodes de son
I √©chantillons de 20 msec √† 8 Kbytes/sec: 160 bytes par trame
I Ent√™te applicative ajout√© √† chaque trame. I Trame+ent√™te sont encapsul√©s dans des segments UDP. I L‚Äôapplication envoi des segments UDP par le biais des
sockets chaque 20 msec pendant une p√©riode de son.
27

Multim√©dia interactif : les pertes et les d√©lais
I pertes de paquets : Les paquets IP peuvent √™tre perdu par cause de congestion (d√©bordement des files d‚Äôattente)
I d√©lai important : Un paquet IP peut √™tre consid√©r√© comme perdu s‚Äôil arrive trop tard au r√©cepteur
I d√©lais dus au traitement, files d‚Äôattente, terminaux (r√©cepteur, √©metteur)
I d√©lai maximal tol√©rable : 400 ms audio, vid√©o
I tol√©rance aux pertes : d√©pend du type de compression, de la compensation, de l‚Äôexistence de FEC.
I taux de pertes entre 1% et 10% peuvent √™tre tol√©r√©
28

Gigue de d√©lai

Quantit√© de donn√©es
donn√©es en m√©moire

transmission CBR
GpODL GX UpVHDX YDULDEOH
JLJXH

r√©ception au client

lecteur CBR au client

Id√©lai au client avant lecture

temps

I La diff√©rence entre les d√©lais de deux paquets cons√©cutives peut √™tre plus ou moins que 20 msec

29

Tampons de r√©ception fixe
I Le r√©cepteur diffuse chaque paquet exactement q msecs apr√®s que la trame a √©t√© g√©n√©r√©. I Si la trame a une estampille √† l‚Äôinstant t : il est diffus√© √† l‚Äôinstant t+q . I Si la trame arrive apr√®s t+q : la trame est consid√©r√©e perdue
I Balance pour q: I grand q: moins de pertes I petit q: meilleur interactivit√©
30

D√©lai de diffusion fixe
‚Ä¢ L‚Äô√©metteur g√©n√®re un paquet toutes les 20 msec durant la p√©riode de son. ‚Ä¢ Le premier paquet est re√ßu √† l‚Äôinstant r ‚Ä¢ Un programme de diffusion : commencer √† p ‚Ä¢ Deuxi√®me programme de diffusion: commencer √† p‚Äô
packets

SDFNHWV JHQHUDWHG

loss
SDFNHWV UHFHLYHG

SOD\RXW VFKHGXOH S
  U
SOD\RXW VFKHGXOH SU

r

p

p‚Äô

time 31

Tampon adaptatif
I Buts :
I minimiser le d√©lai de diffusion I maintien un taux de pertes bas
I Strat√©gie : adapter le d√©lai de diffusion
I Estimer le d√©lai r√©seau, r√©gler le d√©lai de diffusion au d√©but de chaque p√©riode de son.
I Les p√©riodes de silence sont compress√©es et √©long√©es. I Les trames sont toujours diffus√©s chaque 20 msec pendant les
p√©riodes de son.
32

Tampon adaptatif : calcul
t i = timestamp of the ith packet ri = the time packet i is received by receiver pi = the time packet i is played at receiver ri ‚àí t i = network delay for ith packet d i = estimate of average network delay after receiving ith packet
Estimation dynamique du d√©lai moyen au r√©cepteur :
GL = (1 ‚àí X)GL‚àí1 + X(UL ‚àí WL )
X est constant (e.g., X = .01).
33

Tampon adaptatif : calcul bis
L‚Äô√©cart type, YL , peut aussi √™tre estim√© :
YL = (1 ‚àí X)YL‚àí1 + X | UL ‚àí WL ‚àí GL |
GL et YL sont calcul√©s pour chaque paquet, mais sont appliqu√©s au d√©but d‚Äôune p√©riode de parole. Pour le premier paquet d‚Äôune p√©riode de parole l‚Äôinstant de diffusion est :
SL = WL + GL + .YL
pour K un constant positif. Les autres paquets de cette m√™me p√©riode de parole, sont diffus√©s dans une mani√®re p√©riodique.
34

Tampon adaptatif
Q : Comment le r√©cepteur d√©termine que le paquet est le premier d‚Äôune p√©riode de parole ?
I Sans pertes, le r√©cepteur scrute les estampilles successive.
I Si la diff√©rence entre deux estampilles successive > 20
msec --> d√©but de p√©riode de parole. I Avec des pertes, il faut faire attention au num√©ros
de s√©quence aussi.
I diff√©rence entre deux estampilles > 20 msec et num√©ros de s√©quence successive --> d√©but de p√©riode.
I Voir RTP/RTCP
35

R√©sistance contre les pertes (1)

¬´ forward error correction ¬ª I Le d√©lai de diffusion est (FEC) : proc√©dure simple le temps de recevoir

I pour chaque groupe de n toutes les n+1 trames

trames, on cr√©e une trame redondante
I XOR sur les n trames
I on envoi n+1 trames

I Echange :
I n plus grand
I moins on gaspille la bande passante

I le d√©bit augmente par 1/n

I plus de d√©lai de

I on peut reconstruire les n

diffusion

trames originales si on re√ßoit n des n+1 trames

I plus grande la probabilit√© de perdre 2 trames sur n+1

36

R√©sistance contre les pertes (2)
2√®me proc√©dure FEC superposition d‚Äôun flux de qualit√© inf√©rieur ‚Ä¢ par exemple, flux PCM √† 64 kb/s et flux redondant GSM √† 13 kbps.
‚Ä¢ Le r√©cepteur peut cacher toute perte non-consecutive.
37

R√©sistance contre les pertes (3)

3√®me proc√©dure : entrelacement
I les trames sont d√©coup√©es en unit√©s plus petits
I par exemple, 4 unit√©s de 5 msec par trame
I chaque paquet contient des petits unit√©s de plusieurs trames

I si un paquet est perdu, on re√ßoit toujours le plupart de chaque trame
I pas de surd√©bit de redondance
I le d√©lai de diffusion augmente

38

Bilan sur le multim√©dia interactif
I on utilise UDP
I √©viter les d√©lais induits par contr√¥le de congestion TCP
I le r√©cepteur adapte son d√©lai de diffusion
I compensation pour les d√©lais al√©atoires
I le serveur g√®re le d√©bit du flux en fonction de la bande passante disponible sur le chemin client-serveur
I choix parmi des encodages √† diff√©rents d√©bits I la choix peut √™tre dynamique
I compensation pour les pertes
I FEC, entrelacement I des retransmissions, si le temps permis I cacher des erreurs: redondances des flux
39

Plan
I Applications multim√©dia I Streaming d‚Äôaudio et
vid√©o stock√©s
I RTSP
I Exemple de l‚Äôinteractive: t√©l√©phonie sur IP
I Applications en tempsr√©el
I SIP
40

SIP
I Session Initiation Protocol (RFC 3263)
La philosophie de SIP I Tous les appels t√©l√©phoniques et tous les
visioconf√©rences vont avoir lieu dans l‚ÄôInternet. I On identifie les participants par nom ou par m√©l, non
par num√©ro de t√©l√©phone. I On peut toujours joindre son correspondant
I n‚Äôimporte o√π il se trouve I n‚Äôimporte lequel adresse IP il utilise.
41

Les services SIP

I Etablissement de connexion
I Signalisation au correspondant qu‚Äôon veut l‚Äôappeler
I Signalisation pour se mettre d‚Äôaccord sur les medias et l‚Äôencodage
I Signalisation pour la terminaison d‚Äôun appel.

I Recherche de l‚Äôadresse IP du correspondant
I Mappage entre l‚Äôidentifiant mn√©monique et l‚Äôadresse IP actuelle
I Gestion de l‚Äôappel
I Ajout de nouveaux flux de media en cours d‚Äôappel
I Changement d‚Äôencodage en cours d‚Äôappel
I Invitations aux autres I Transfert d‚Äôappel, mise en
garde
42

Exemple : √©tablissement d‚Äôappel

Alice

Bob

167.180.112.24

193.64.210.89

mcIN==IVaNIuTIdPEio4b31o86b07@6.10189R03.T.16P14/2A.2.2V14P0.089

port 5060 Bob‚Äôs terminal rings

port 5060

200 OK c=IN IP4
m=audio

193.64.210.89 48753 RTP/AVP

3

ACK

port 5060

port 38060

¬µ Law audio

GSM

port 48753

time

time

‚Ä¢ Alice invite Bob √† communiquer (port 5060)
‚Ä¢ son message SIP invite contient son num√©ro de port et son adresse IP ‚Ä¢ il indique que Alice pr√©f√®re de recevoir l‚Äôencodage PCM ulaw ‚Ä¢ Le message 200 OK de Bob indique ‚Ä¢ son adresse IP et num√©ro de port pour la communication ‚Ä¢ sa pr√©f√©rence pour l‚Äôencodage GSM ‚Ä¢ Les messages SIP peuvent √™tre TCP or UDP; ici RTP/UDP.
43

Etablissement d‚Äôappel bis

I N√©gociation de l‚Äôencodage:
I Supposons que Bob ne dispose pas de l‚Äôencodeur PCM ulaw.
I Bob r√©pond par 606 Not Acceptable Reply. Il fourni la liste des encodeurs dont il peut s‚Äôen servir.
I Alice peut ensuite envoyer un nouveau message INVITE, proposant un encodeur adapt√©.

I Rejet d‚Äôappel
I Bob peut rejeter des appels avec les r√©ponses replies ¬´ occup√© ¬ª, ¬´ absent ¬ª, ¬´ cr√©dit insuffisant ¬ª, ou ¬´ interdit ¬ª.

44

Exemple d‚Äôun message SIP

INVITE sip:bob@domain.com SIP/2.0 Via: SIP/2.0/UDP 167.180.112.24 From: sip:alice@hereway.com To: sip:bob@domain.com Call-ID: a2e3a@pigeon.hereway.com Content-Type: application/sdp Content-Length: 885
c=IN IP4 167.180.112.24 m=audio 38060 RTP/AVP 0
A noter: I syntaxe HTTP I sdp = session description protocol I unicit√© d‚Äôidentifiants Call-ID

‚Ä¢ Dans ce cas, Alice ne conna√Æt pas l‚Äôadresse IP de Bob. ‚Ä¢Des serveurs intermediares sont n√©cessaires.
‚Ä¢Alice envoi et re√ßoit des messages SIP sur le num√©ro de port par d√©faut 5060.
‚Ä¢ Alice indique dans l‚Äôent√™te Via que son client SIP envoi et re√ßoit par UDP.
45

Annuaire et localisation

I Comment appeler si on

I L‚Äôinformation fourni peut

conna√Æt seulement le nom ou varier selon :

l‚Äôadresse m√©l ?

I l‚Äôhoraire (travail, maison)

I Comment conna√Ætre l‚Äôadresse IP actuel du correspondant ?
I le correspondant se d√©place I il utilise le protocole DHCP I il a plusieurs appareils IP (PC,
PDA, voiture)

I celui qui appel (√©viter qu‚Äôun appel professionnel est diriger vers le foyer)
I l‚Äô√©tat du correspondant (quand il est occup√©, on dirige les appels vers le r√©pondeur)

Les serveurs SIP :

I SIP registrar

I SIP proxy

46

SIP Registrar
I Quand Bob allume son client SIP, le client envoi un message SIP REGISTER message au Registrar Server (comme dans la messagerie instantan√©e)
message REGISTER :
REGISTER sip:domain.com SIP/2.0 Via: SIP/2.0/UDP 193.64.210.89 From: sip:bob@domain.com To: sip:bob@domain.com Expires: 3600
47

SIP Proxy
I Alice envoi un message INVITE √† son serveur proxy
I il contient l‚Äôadresse sip:bob@domain.com
I Le proxy est responsable for l‚Äôacheminement des messages SIP vers le correspondant
I les messages peuvent passer par plusieurs serveurs proxy
I Le correspondant envoi sa r√©ponse via le m√™me ensemble de serveurs proxy.
I Le proxy fourni la r√©ponse SIP √† Alice
I la r√©ponse contient l‚Äôadresse IP de Bob
I A noter : un proxy se ressemble √† un serveur DNS
48

Appel de jim@umass.edu vers keith@upenn.edu

Exemple

6,3 UHJLVWUDU XSHQQHGX

(1) Jim envoi un message INVITE au SIP proxy de umass. (2) Le proxy renvoi le message vers le SIP registrar de upenn. (3) Le registrar de upenn r√©pond avec un message REDIRECT, indiquant qu‚Äôil faut contacter keith@eurecom.fr

6,3 SUR[\ XPDVVHGX
1 8
6,3 FOLHQW 

2 3 4 7
9

6,3 UHJLVWUDU HXUHFRPIU
5 6
6,3 FOLHQW 

(4) Le proxy umass envoi un INVITE au registrar eurecom. (5) Le registrar eurecom renvoi le message INVITE √† 197.87.54.21, sur lequel tourne le client SIP de keith. (6-8) r√©ponse SIP (9) media envoy√© directement entre les clients.

$ QRWHU il y a aussi des acquittements SIP (pas montr√©s).
49

Comparaison avec H.323

I H.323 est un autre protocole de signalisation pour l‚Äôinteractive en temps r√©el
I H.323 est un ensemble monolithique de protocoles pour le visioconf√©rence : signalisation, enregistrement, contr√¥le d‚Äôadmission, transport, et encodage.
I SIP est un composant modulaire. Il est compatible avec RTP. Il peut fonctionner avec d‚Äôautres protocoles et services aussi.

I H.323 a √©t√© d√©velopp√© √† l‚ÄôUIT (t√©l√©phonie).
I SIP a √©t√© d√©velopp√© √† l‚ÄôIETF: Il est inspir√© par HTTP.
I SIP est plus simple (et alors plus efficace ?)
50

